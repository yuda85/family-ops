import{d as I}from"./chunk-X4QG5DAP.js";import{a,d as g,e as y,i as w,j as _}from"./chunk-JFU3JZIN.js";import{T as E,Y as m,oa as d,uc as p}from"./chunk-QZLPLYI5.js";import{f as l}from"./chunk-ATWMZ64T.js";var S=class D{firestoreService=m(w);authService=m(_);familyService=m(I);_events=d([]);_viewStartDate=d(new Date);_viewEndDate=d(new Date);_isLoading=d(!1);_error=d(null);events=this._events.asReadonly();isLoading=this._isLoading.asReadonly();error=this._error.asReadonly();expandedEvents=p(()=>{let t=this._events(),e=this._viewStartDate(),n=this._viewEndDate(),r=[];for(let i of t)if(i.recurrence){let s=this.generateRecurringInstances(i,e,n);r.push(...s)}else r.push({event:i,instanceDate:i.start.toDate(),instanceStart:i.start.toDate(),instanceEnd:i.end.toDate()});return r.sort((i,s)=>i.instanceStart.getTime()-s.instanceStart.getTime())});generateRecurringInstances(t,e,n){let r=[],i=t.recurrence,s=t.start.toDate(),f=t.end.toDate(),o=i.endDate.toDate(),u=f.getTime()-s.getTime(),C=s.getHours(),R=s.getMinutes(),h=new Date(Math.max(e.getTime(),s.getTime()));h.setDate(h.getDate()-h.getDay());let L=new Date(Math.min(n.getTime(),o.getTime())),v=new Date(h);for(;v<=L;){let M=v.getDay();if(i.daysOfWeek.includes(M)){let c=new Date(v);if(c.setHours(C,R,0,0),c>=s&&c>=e&&c<=n){let T=new Date(c.getTime()+u);r.push({event:t,instanceDate:new Date(c),instanceStart:c,instanceEnd:T})}}v.setDate(v.getDate()+1)}return r}loadEvents(t,e){return l(this,null,function*(){let n=this.familyService.familyId();if(!n){this._events.set([]);return}this._isLoading.set(!0),this._error.set(null),this._viewStartDate.set(t),this._viewEndDate.set(e);try{let r=yield this.firestoreService.getCollection(`families/${n}/events`,g("start",">=",a.fromDate(t)),g("start","<=",a.fromDate(e)),y("start","asc")),s=(yield this.firestoreService.getCollection(`families/${n}/events`,g("start","<",a.fromDate(t)),y("start","asc"))).filter(o=>o.recurrence?o.recurrence.endDate.toDate()>=t:!1),f=[...r];for(let o of s)f.some(u=>u.id===o.id)||f.push(o);this._events.set(f)}catch(r){console.error("Error loading events:",r),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05D4\u05D0\u05D9\u05E8\u05D5\u05E2\u05D9\u05DD")}finally{this._isLoading.set(!1)}})}getEvent(t){return l(this,null,function*(){let e=this.familyService.familyId();if(!e)return null;try{return yield this.firestoreService.getDocument(`families/${e}/events/${t}`)}catch(n){return console.error("Error getting event:",n),null}})}createEvent(t){return l(this,null,function*(){let e=this.familyService.familyId(),n=this.authService.userId();if(!e||!n)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D9\u05E6\u05D5\u05E8 \u05D0\u05D9\u05E8\u05D5\u05E2\u05D9\u05DD");this._isLoading.set(!0),this._error.set(null);try{let r={title:t.title,description:t.description||null,location:t.location||null,category:t.category,isFamilyEvent:t.childrenIds.length===0,start:a.fromDate(t.start),end:a.fromDate(t.end),isAllDay:t.isAllDay,childrenIds:t.childrenIds,needsRide:t.needsRide,createdBy:n};return t.recurrence&&t.recurrence.daysOfWeek.length>0&&(r.recurrence={daysOfWeek:t.recurrence.daysOfWeek,endDate:a.fromDate(t.recurrence.endDate)}),yield this.firestoreService.createDocument(`families/${e}/events`,r)}catch(r){throw console.error("Error creating event:",r),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D9\u05E6\u05D9\u05E8\u05EA \u05D4\u05D0\u05D9\u05E8\u05D5\u05E2"),r}finally{this._isLoading.set(!1)}})}updateEvent(t,e){return l(this,null,function*(){let n=this.familyService.familyId();if(!n)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E2\u05D3\u05DB\u05DF \u05D0\u05D9\u05E8\u05D5\u05E2\u05D9\u05DD");this._isLoading.set(!0),this._error.set(null);try{let r={};e.title!==void 0&&(r.title=e.title),e.description!==void 0&&(r.description=e.description||null),e.location!==void 0&&(r.location=e.location||null),e.category!==void 0&&(r.category=e.category),e.start!==void 0&&(r.start=a.fromDate(e.start)),e.end!==void 0&&(r.end=a.fromDate(e.end)),e.isAllDay!==void 0&&(r.isAllDay=e.isAllDay),e.childrenIds!==void 0&&(r.childrenIds=e.childrenIds,r.isFamilyEvent=e.childrenIds.length===0),e.needsRide!==void 0&&(r.needsRide=e.needsRide),e.driverUserId!==void 0&&(r.driverUserId=e.driverUserId||null),yield this.firestoreService.updateDocument(`families/${n}/events/${t}`,r)}catch(r){throw console.error("Error updating event:",r),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05E2\u05D3\u05DB\u05D5\u05DF \u05D4\u05D0\u05D9\u05E8\u05D5\u05E2"),r}finally{this._isLoading.set(!1)}})}deleteEvent(t){return l(this,null,function*(){let e=this.familyService.familyId();if(!e)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05DE\u05D7\u05D5\u05E7 \u05D0\u05D9\u05E8\u05D5\u05E2\u05D9\u05DD");this._isLoading.set(!0),this._error.set(null);try{yield this.firestoreService.deleteDocument(`families/${e}/events/${t}`),this._events.update(n=>n.filter(r=>r.id!==t))}catch(n){throw console.error("Error deleting event:",n),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05DE\u05D7\u05D9\u05E7\u05EA \u05D4\u05D0\u05D9\u05E8\u05D5\u05E2"),n}finally{this._isLoading.set(!1)}})}getEventsForDate(t){let e=t.toDateString();return this.expandedEvents().filter(n=>n.instanceDate.toDateString()===e)}clearError(){this._error.set(null)}static \u0275fac=function(e){return new(e||D)};static \u0275prov=E({token:D,factory:D.\u0275fac,providedIn:"root"})};export{S as a};
