import{d as S}from"./chunk-WPQFOBGJ.js";import{a as y,e as g,i as f,j as v}from"./chunk-IGP4P7SY.js";import{T as p,Y as u,oa as c,tc as d}from"./chunk-HNLZOKXJ.js";import{f as l}from"./chunk-ATWMZ64T.js";var P=class h{firestoreService=u(f);authService=u(v);familyService=u(S);_history=c([]);_patterns=c([]);_isLoading=c(!1);_error=c(null);history=this._history.asReadonly();patterns=this._patterns.asReadonly();isLoading=this._isLoading.asReadonly();error=this._error.asReadonly();monthlySpending=d(()=>{let e=this._history(),t=new Map,r=["\u05D9\u05E0\u05D5\u05D0\u05E8","\u05E4\u05D1\u05E8\u05D5\u05D0\u05E8","\u05DE\u05E8\u05E5","\u05D0\u05E4\u05E8\u05D9\u05DC","\u05DE\u05D0\u05D9","\u05D9\u05D5\u05E0\u05D9","\u05D9\u05D5\u05DC\u05D9","\u05D0\u05D5\u05D2\u05D5\u05E1\u05D8","\u05E1\u05E4\u05D8\u05DE\u05D1\u05E8","\u05D0\u05D5\u05E7\u05D8\u05D5\u05D1\u05E8","\u05E0\u05D5\u05D1\u05DE\u05D1\u05E8","\u05D3\u05E6\u05DE\u05D1\u05E8"];for(let a of e){let i=a.completedAt??a.createdAt,o=i?i.toDate():new Date,s=`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}`,m=`${r[o.getMonth()]} ${o.getFullYear()}`,n=t.get(s)||{month:s,monthLabel:m,totalEstimated:0,totalActual:0,tripCount:0};n.totalEstimated+=a.estimatedTotal,n.totalActual+=a.actualTotal,n.tripCount+=1,t.set(s,n)}return Array.from(t.values()).sort((a,i)=>i.month.localeCompare(a.month))});totalStats=d(()=>{let e=this._history();return{totalTrips:e.length,totalEstimated:e.reduce((t,r)=>t+r.estimatedTotal,0),totalActual:e.reduce((t,r)=>t+r.actualTotal,0),averageTrip:e.length>0?e.reduce((t,r)=>t+r.actualTotal,0)/e.length:0}});estimateAccuracy=d(()=>{let e=this.totalStats();return e.totalEstimated===0?100:Math.round(e.totalActual/e.totalEstimated*100)});loadHistory(e=50){return l(this,null,function*(){let t=this.familyService.familyId();if(!t){this._history.set([]);return}this._isLoading.set(!0),this._error.set(null);try{let r=yield this.firestoreService.getCollection(`families/${t}/shoppingHistory`);r=r.sort((a,i)=>{let o=a.completedAt?.toMillis()??a.createdAt?.toMillis()??0;return(i.completedAt?.toMillis()??i.createdAt?.toMillis()??0)-o}),this._history.set(r.slice(0,e))}catch(r){console.error("Error loading history:",r),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05D4\u05D9\u05E1\u05D8\u05D5\u05E8\u05D9\u05D9\u05EA \u05D4\u05E7\u05E0\u05D9\u05D5\u05EA")}finally{this._isLoading.set(!1)}})}loadPatterns(){return l(this,null,function*(){let e=this.familyService.familyId();if(!e){this._patterns.set([]);return}try{let t=yield this.firestoreService.getCollection(`families/${e}/purchasePatterns`,g("purchaseCount","desc"));this._patterns.set(t)}catch(t){console.error("Error loading patterns:",t)}})}getTrip(e){return l(this,null,function*(){let t=this.familyService.familyId();if(!t)return null;try{return yield this.firestoreService.getDocument(`families/${t}/shoppingHistory/${e}`)}catch(r){return console.error("Error getting trip:",r),null}})}updatePatterns(e){return l(this,null,function*(){let t=this.familyService.familyId();if(!t)return;let r=y.now();for(let a of e.items){if(!a.wasChecked)continue;let i=this._patterns().find(o=>o.itemName===a.name&&o.category===a.category);if(i){let o=Math.floor((r.toMillis()-i.lastPurchased.toMillis())/864e5),s=i.purchaseCount+1,m=(i.averageQuantity*i.purchaseCount+a.quantity)/s,n=(i.averageIntervalDays*(i.purchaseCount-1)+o)/i.purchaseCount;yield this.firestoreService.updateDocument(`families/${t}/purchasePatterns/${i.id}`,{purchaseCount:s,lastPurchased:r,averageQuantity:m,averageIntervalDays:n})}else yield this.firestoreService.createDocument(`families/${t}/purchasePatterns`,{familyId:t,catalogItemId:null,itemName:a.name,category:a.category,purchaseCount:1,lastPurchased:r,averageQuantity:a.quantity,averageIntervalDays:7})}yield this.loadPatterns()})}getSuggestedItems(){let e=this._patterns(),t=Date.now();return e.filter(r=>{let a=r.lastPurchased.toMillis();return Math.floor((t-a)/(1e3*60*60*24))>=r.averageIntervalDays*.8})}clearError(){this._error.set(null)}static \u0275fac=function(t){return new(t||h)};static \u0275prov=p({token:h,factory:h.\u0275fac,providedIn:"root"})};export{P as a};
