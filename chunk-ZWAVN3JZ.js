import{a as I}from"./chunk-FGIU4WVQ.js";import{d as _}from"./chunk-WPQFOBGJ.js";import{a as m,e as S,i as b,j as C}from"./chunk-IGP4P7SY.js";import{T as v,Y as g,oa as l,tc as p}from"./chunk-HNLZOKXJ.js";import{f as a}from"./chunk-ATWMZ64T.js";var y=[{id:"planning",labelHe:"\u05D1\u05EA\u05DB\u05E0\u05D5\u05DF",icon:"edit_note",color:"#868e96",order:0},{id:"active",labelHe:"\u05E4\u05E2\u05D9\u05DC",icon:"play_circle",color:"#228be6",order:1},{id:"completed",labelHe:"\u05D4\u05D5\u05E9\u05DC\u05DD",icon:"check_circle",color:"#40c057",order:2},{id:"archived",labelHe:"\u05D1\u05D0\u05E8\u05DB\u05D9\u05D5\u05DF",icon:"inventory_2",color:"#adb5bd",order:3}];function T(c){return y.find(e=>e.id===c)??y[0]}var D=[{id:"low",labelHe:"\u05E0\u05DE\u05D5\u05DB\u05D4",icon:"keyboard_arrow_down",color:"#868e96"},{id:"medium",labelHe:"\u05D1\u05D9\u05E0\u05D5\u05E0\u05D9\u05EA",icon:"remove",color:"#fab005"},{id:"high",labelHe:"\u05D2\u05D1\u05D5\u05D4\u05D4",icon:"keyboard_arrow_up",color:"#fd7e14"},{id:"urgent",labelHe:"\u05D3\u05D7\u05D5\u05E3",icon:"priority_high",color:"#fa5252"}];function E(c){return D.find(e=>e.id===c)??D[1]}var h=[{id:"vacation",labelHe:"\u05D7\u05D5\u05E4\u05E9\u05D4",icon:"flight_takeoff",color:"#20c997"},{id:"home",labelHe:"\u05D1\u05D9\u05EA",icon:"home",color:"#845ef7"},{id:"finance",labelHe:"\u05DB\u05E1\u05E4\u05D9\u05DD",icon:"account_balance",color:"#fab005"},{id:"education",labelHe:"\u05D7\u05D9\u05E0\u05D5\u05DA",icon:"school",color:"#5c7cfa"},{id:"health",labelHe:"\u05D1\u05E8\u05D9\u05D0\u05D5\u05EA",icon:"medical_services",color:"#e64980"},{id:"celebration",labelHe:"\u05D0\u05D9\u05E8\u05D5\u05E2",icon:"celebration",color:"#ff922b"},{id:"purchase",labelHe:"\u05E8\u05DB\u05D9\u05E9\u05D4",icon:"shopping_bag",color:"#74c0fc"},{id:"general",labelHe:"\u05DB\u05DC\u05DC\u05D9",icon:"topic",color:"#868e96"}];function P(c){return h.find(e=>e.id===c)??h[h.length-1]}var k=class c{firestoreService=g(b);authService=g(C);familyService=g(_);calendarService=g(I);topicsSubscription;currentTopicSubscription;_topics=l([]);_currentTopic=l(null);_isLoading=l(!1);_error=l(null);_filterStatus=l("all");_filterCategory=l("all");_searchQuery=l("");_collapsedStatuses=l(new Set(["completed","archived"]));topics=this._topics.asReadonly();currentTopic=this._currentTopic.asReadonly();isLoading=this._isLoading.asReadonly();error=this._error.asReadonly();filterStatus=this._filterStatus.asReadonly();filterCategory=this._filterCategory.asReadonly();searchQuery=this._searchQuery.asReadonly();totalCount=p(()=>this._topics().length);activeTopicsCount=p(()=>this._topics().filter(e=>e.status==="active"||e.status==="planning").length);filteredTopics=p(()=>{let e=this._topics(),t=this._filterStatus(),i=this._filterCategory(),o=this._searchQuery().toLowerCase().trim();return t!=="all"&&(e=e.filter(r=>r.status===t)),i!=="all"&&(e=e.filter(r=>r.category===i)),o&&(e=e.filter(r=>r.title.toLowerCase().includes(o)||r.description.toLowerCase().includes(o))),e});groupedTopics=p(()=>{let e=this.filteredTopics(),t=this._collapsedStatuses(),i=new Map;for(let r of e){let s=i.get(r.status)||[];s.push(r),i.set(r.status,s)}let o=[];for(let r of y){let s=i.get(r.id);s&&s.length>0&&(s.sort((n,d)=>{if(n.isPinned&&!d.isPinned)return-1;if(!n.isPinned&&d.isPinned)return 1;let u=n.updatedAt?.toMillis()??n.createdAt?.toMillis()??0;return(d.updatedAt?.toMillis()??d.createdAt?.toMillis()??0)-u}),o.push({status:r.id,statusMeta:r,topics:s,isCollapsed:t.has(r.id)}))}return o});currentTopicProgress=p(()=>{let e=this._currentTopic();return!e||e.taskCount===0?0:e.completedTaskCount/e.taskCount*100});currentTopicHasTasks=p(()=>{let e=this._currentTopic();return e?e.taskCount>0:!1});ngOnDestroy(){this.unsubscribe()}subscribeToTopics(){let e=this.familyService.familyId();if(!e){this._topics.set([]);return}this._isLoading.set(!0),this._error.set(null),this.topicsSubscription?.unsubscribe(),this.topicsSubscription=this.firestoreService.getCollection$(`families/${e}/topics`,S("updatedAt","desc")).subscribe({next:t=>{this._topics.set(t),this._isLoading.set(!1)},error:t=>{console.error("Error subscribing to topics:",t),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05E0\u05D5\u05E9\u05D0\u05D9\u05DD"),this._isLoading.set(!1)}})}subscribeToTopic(e){let t=this.familyService.familyId();if(!t){this._currentTopic.set(null);return}this.currentTopicSubscription?.unsubscribe(),this.currentTopicSubscription=this.firestoreService.getDocument$(`families/${t}/topics/${e}`).subscribe({next:i=>{this._currentTopic.set(i)},error:i=>{console.error("Error subscribing to topic:",i),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05E0\u05D5\u05E9\u05D0")}})}loadTopic(e){return a(this,null,function*(){let t=this.familyService.familyId();if(!t)return null;try{let i=yield this.firestoreService.getDocument(`families/${t}/topics/${e}`);return this._currentTopic.set(i),i}catch(i){return console.error("Error loading topic:",i),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05E0\u05D5\u05E9\u05D0"),null}})}createTopic(e){return a(this,null,function*(){let t=this.familyService.familyId(),i=this.authService.userId();if(!t||!i)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D9\u05E6\u05D5\u05E8 \u05E0\u05D5\u05E9\u05D0\u05D9\u05DD");let o={familyId:t,title:e.title,description:e.description||"",category:e.category,priority:e.priority||"medium",status:"planning",contentSections:[],linkedEventIds:[],linkedChildrenIds:e.linkedChildrenIds||[],targetDate:e.targetDate?m.fromDate(e.targetDate):void 0,deadline:e.deadline?m.fromDate(e.deadline):void 0,activeEditors:[],taskCount:0,completedTaskCount:0,commentCount:0,attachmentCount:0,isPinned:!1,createdBy:i},r=yield this.firestoreService.createDocument(`families/${t}/topics`,o);if(yield this.logActivity(r,"topic_created","\u05E0\u05D5\u05E6\u05E8 \u05E0\u05D5\u05E9\u05D0 \u05D7\u05D3\u05E9"),e.targetDate)try{let s=this.mapTopicCategoryToEventCategory(e.category),n=yield this.calendarService.createEvent({title:e.title,description:e.description||"",category:s,start:e.targetDate,end:e.targetDate,isAllDay:!0,childrenIds:e.linkedChildrenIds||[],needsRide:!1});yield this.linkEvent(r,n)}catch(s){console.error("Error creating calendar event for topic:",s)}return r})}mapTopicCategoryToEventCategory(e){return{vacation:"vacation",home:"other",finance:"other",education:"school",health:"health",celebration:"family",purchase:"other",general:"general"}[e]||"general"}updateTopic(e,t){return a(this,null,function*(){let i=this.familyService.familyId(),o=this.authService.userId();if(!i||!o)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E2\u05D3\u05DB\u05DF \u05E0\u05D5\u05E9\u05D0\u05D9\u05DD");let r={lastEditedBy:o,lastEditedAt:this.firestoreService.getServerTimestamp()};t.title!==void 0&&(r.title=t.title),t.description!==void 0&&(r.description=t.description),t.category!==void 0&&(r.category=t.category),t.priority!==void 0&&(r.priority=t.priority),t.linkedChildrenIds!==void 0&&(r.linkedChildrenIds=t.linkedChildrenIds),t.isPinned!==void 0&&(r.isPinned=t.isPinned,r.pinnedAt=t.isPinned?this.firestoreService.getServerTimestamp():null),t.contentSections!==void 0&&(r.contentSections=t.contentSections),t.targetDate!==void 0&&(r.targetDate=t.targetDate?m.fromDate(t.targetDate):null),t.deadline!==void 0&&(r.deadline=t.deadline?m.fromDate(t.deadline):null),yield this.firestoreService.updateDocument(`families/${i}/topics/${e}`,r),yield this.logActivity(e,"topic_updated","\u05E2\u05D5\u05D3\u05DB\u05E0\u05D5 \u05E4\u05E8\u05D8\u05D9 \u05D4\u05E0\u05D5\u05E9\u05D0")})}changeStatus(e,t){return a(this,null,function*(){let i=this.familyService.familyId(),o=this.authService.userId();if(!i||!o)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E9\u05E0\u05D5\u05EA \u05E1\u05D8\u05D8\u05D5\u05E1");let s=(this._currentTopic()||this._topics().find(f=>f.id===e))?.status,n={status:t,lastEditedBy:o,lastEditedAt:this.firestoreService.getServerTimestamp()};t==="completed"?(n.completedAt=this.firestoreService.getServerTimestamp(),n.completedBy=o):(n.completedAt=null,n.completedBy=null),yield this.firestoreService.updateDocument(`families/${i}/topics/${e}`,n);let d=s?T(s).labelHe:"",u=T(t).labelHe;yield this.logActivity(e,"status_changed",`\u05E9\u05D5\u05E0\u05D4 \u05E1\u05D8\u05D8\u05D5\u05E1 \u05DE-${d} \u05DC-${u}`,void 0,void 0,s,t)})}togglePin(e){return a(this,null,function*(){let t=this._currentTopic()||this._topics().find(i=>i.id===e);t&&(yield this.updateTopic(e,{isPinned:!t.isPinned}))})}deleteTopic(e){return a(this,null,function*(){let t=this.familyService.familyId();if(!t)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.isAdmin())throw new Error("\u05E8\u05E7 \u05DE\u05E0\u05D4\u05DC \u05D9\u05DB\u05D5\u05DC \u05DC\u05DE\u05D7\u05D5\u05E7 \u05E0\u05D5\u05E9\u05D0\u05D9\u05DD");yield this.firestoreService.deleteDocument(`families/${t}/topics/${e}`),this._currentTopic()?.id===e&&this._currentTopic.set(null)})}linkEvent(e,t){return a(this,null,function*(){let i=this.familyService.familyId();if(!i)return;let o=this._currentTopic()||this._topics().find(s=>s.id===e);if(!o)return;let r=[...o.linkedEventIds];r.includes(t)||(r.push(t),yield this.firestoreService.updateDocument(`families/${i}/topics/${e}`,{linkedEventIds:r}),yield this.logActivity(e,"event_linked","\u05E7\u05D5\u05E9\u05E8 \u05D0\u05D9\u05E8\u05D5\u05E2 \u05DC\u05E0\u05D5\u05E9\u05D0"))})}unlinkEvent(e,t){return a(this,null,function*(){let i=this.familyService.familyId();if(!i)return;let o=this._currentTopic()||this._topics().find(s=>s.id===e);if(!o)return;let r=o.linkedEventIds.filter(s=>s!==t);yield this.firestoreService.updateDocument(`families/${i}/topics/${e}`,{linkedEventIds:r})})}joinEditing(e){return a(this,null,function*(){let t=this.familyService.familyId(),i=this.authService.userId();if(!t||!i)return;let o=this._currentTopic();if(!o)return;let r=[...o.activeEditors];r.includes(i)||(r.push(i),yield this.firestoreService.updateDocument(`families/${t}/topics/${e}`,{activeEditors:r}))})}leaveEditing(e){return a(this,null,function*(){let t=this.familyService.familyId(),i=this.authService.userId();if(!t||!i)return;let o=this._currentTopic();if(!o)return;let r=o.activeEditors.filter(s=>s!==i);yield this.firestoreService.updateDocument(`families/${t}/topics/${e}`,{activeEditors:r})})}setStatusFilter(e){this._filterStatus.set(e)}setCategoryFilter(e){this._filterCategory.set(e)}setSearchQuery(e){this._searchQuery.set(e)}toggleStatusCollapsed(e){this._collapsedStatuses.update(t=>{let i=new Set(t);return i.has(e)?i.delete(e):i.add(e),i})}clearCurrentTopic(){this._currentTopic.set(null),this.currentTopicSubscription?.unsubscribe()}clearError(){this._error.set(null)}unsubscribe(){this.topicsSubscription?.unsubscribe(),this.currentTopicSubscription?.unsubscribe()}logActivity(e,t,i,o,r,s,n){return a(this,null,function*(){let d=this.familyService.familyId(),u=this.authService.userId();if(!(!d||!u))try{yield this.firestoreService.createDocument(`families/${d}/topics/${e}/activities`,{topicId:e,type:t,description:i,targetId:o||null,targetType:r||null,oldValue:s||null,newValue:n||null,performedBy:u})}catch(f){console.error("Error logging activity:",f)}})}myPendingTasksCount=p(()=>0);getRecentActivity(e=10){return a(this,null,function*(){return[]})}static \u0275fac=function(t){return new(t||c)};static \u0275prov=v({token:c,factory:c.\u0275fac,providedIn:"root"})};export{y as a,T as b,D as c,E as d,h as e,P as f,k as g};
