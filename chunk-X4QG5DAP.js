import{a as v,e as p,i as w,j as D}from"./chunk-JFU3JZIN.js";import{T as f,X as m,oa as l,uc as n}from"./chunk-QZLPLYI5.js";import{a as c,b as u,f as a}from"./chunk-ATWMZ64T.js";var y={weekStartDay:"sunday"},h=[{id:"school",labelHe:"\u05D1\u05D9\u05EA \u05E1\u05E4\u05E8",icon:"school",color:"#5c7cfa"},{id:"activity",labelHe:"\u05D7\u05D5\u05D2",icon:"sports_soccer",color:"#ff922b"},{id:"family",labelHe:"\u05DE\u05E9\u05E4\u05D7\u05D4",icon:"family_restroom",color:"#c4704f"},{id:"general",labelHe:"\u05DB\u05DC\u05DC\u05D9",icon:"event",color:"#868e96"},{id:"vacation",labelHe:"\u05D7\u05D5\u05E4\u05E9\u05D4",icon:"beach_access",color:"#20c997"},{id:"car",labelHe:"\u05E8\u05DB\u05D1",icon:"directions_car",color:"#845ef7"},{id:"health",labelHe:"\u05D1\u05E8\u05D9\u05D0\u05D5\u05EA",icon:"medical_services",color:"#e64980"},{id:"other",labelHe:"\u05D0\u05D7\u05E8",icon:"more_horiz",color:"#b5a795"}];function C(o){return h.find(e=>e.id===o)??h[h.length-1]}var b=["#e07a5f","#81b1cb","#87a878","#a89cc8","#f4a261","#e9c46a","#2a9d8f","#e76f51"];function E(o){let e=b.filter(r=>!o.includes(r));return e.length>0?e[0]:b[0]}var I=class o{constructor(e,r){this.firestoreService=e;this.authService=r}_currentFamily=l(null);_members=l([]);_children=l([]);_isLoading=l(!1);_error=l(null);currentFamily=this._currentFamily.asReadonly();members=this._members.asReadonly();children=this._children.asReadonly();isLoading=this._isLoading.asReadonly();error=this._error.asReadonly();familyId=n(()=>this._currentFamily()?.id??null);familyName=n(()=>this._currentFamily()?.name??null);currentUserRole=n(()=>{let e=this.familyId();return e?this.authService.getFamilyRole(e):null});isOwner=n(()=>this.currentUserRole()==="owner");isAdmin=n(()=>{let e=this.currentUserRole();return e==="owner"||e==="admin"});canEdit=n(()=>{let e=this.currentUserRole();return e==="owner"||e==="admin"||e==="member"});sortedChildren=n(()=>[...this._children()].sort((e,r)=>e.order-r.order));weekStartDay=n(()=>this._currentFamily()?.settings?.weekStartDay??y.weekStartDay);loadFamily(e){return a(this,null,function*(){this._isLoading.set(!0),this._error.set(null);try{let r=yield this.firestoreService.getDocument(`families/${e}`);if(!r)throw new Error("\u05DE\u05E9\u05E4\u05D7\u05D4 \u05DC\u05D0 \u05E0\u05DE\u05E6\u05D0\u05D4");this._currentFamily.set(r),yield Promise.all([this.loadMembers(e),this.loadChildren(e)])}catch(r){throw console.error("Error loading family:",r),this._error.set(r.message||"\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4"),r}finally{this._isLoading.set(!1)}})}loadMembers(e){return a(this,null,function*(){let r=yield this.firestoreService.getCollection(`families/${e}/members`);this._members.set(r)})}loadChildren(e){return a(this,null,function*(){let r=yield this.firestoreService.getCollection(`families/${e}/children`,p("order","asc"));this._children.set(r)})}createFamily(e){return a(this,null,function*(){let r=this.authService.userId(),t=this.authService.user();if(!r||!t)throw new Error("\u05DE\u05E9\u05EA\u05DE\u05E9 \u05DC\u05D0 \u05DE\u05D7\u05D5\u05D1\u05E8");this._isLoading.set(!0),this._error.set(null);try{let i=yield this.firestoreService.createDocument("families",{name:e.name,ownerUserId:r});return yield this.firestoreService.setDocument(`families/${i}/members/${r}`,{displayName:t.displayName,email:t.email,photoURL:t.photoURL,role:"owner",joinedAt:this.firestoreService.getServerTimestamp(),invitedBy:r}),yield this.authService.addFamilyMembership(i,"owner"),i}catch(i){throw console.error("Error creating family:",i),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D9\u05E6\u05D9\u05E8\u05EA \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4"),i}finally{this._isLoading.set(!1)}})}updateFamily(e){return a(this,null,function*(){let r=this.familyId();if(!r)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.isAdmin())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E2\u05D3\u05DB\u05DF \u05D0\u05EA \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4");try{yield this.firestoreService.updateDocument(`families/${r}`,e),yield this.loadFamily(r)}catch(t){throw console.error("Error updating family:",t),t}})}updateFamilySettings(e){return a(this,null,function*(){let r=this.familyId();if(!r)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.isAdmin())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E2\u05D3\u05DB\u05DF \u05D4\u05D2\u05D3\u05E8\u05D5\u05EA");try{let t=this._currentFamily(),i=t?.settings??y,s=c(c({},i),e);yield this.firestoreService.updateDocument(`families/${r}`,{settings:s}),t&&this._currentFamily.set(u(c({},t),{settings:s}))}catch(t){throw console.error("Error updating family settings:",t),t}})}addChild(e){return a(this,null,function*(){let r=this.familyId(),t=this.authService.userId();if(!r||!t)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D4\u05D5\u05E1\u05D9\u05E3 \u05D9\u05DC\u05D3\u05D9\u05DD");try{let i=this._children(),s=i.map(T=>T.color),d=e.color??E(s),F=i.length,g={name:e.name,color:d,order:F,createdBy:t};e.birthYear!==void 0&&e.birthYear!==null&&(g.birthYear=e.birthYear);let S=yield this.firestoreService.createDocument(`families/${r}/children`,g);return yield this.loadChildren(r),S}catch(i){throw console.error("Error adding child:",i),i}})}updateChild(e,r){return a(this,null,function*(){let t=this.familyId();if(!t)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E2\u05D3\u05DB\u05DF \u05D9\u05DC\u05D3\u05D9\u05DD");try{yield this.firestoreService.updateDocument(`families/${t}/children/${e}`,r),yield this.loadChildren(t)}catch(i){throw console.error("Error updating child:",i),i}})}deleteChild(e){return a(this,null,function*(){let r=this.familyId();if(!r)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05DE\u05D7\u05D5\u05E7 \u05D9\u05DC\u05D3\u05D9\u05DD");try{yield this.firestoreService.deleteDocument(`families/${r}/children/${e}`),yield this.loadChildren(r)}catch(t){throw console.error("Error deleting child:",t),t}})}createInvite(e){return a(this,null,function*(){let r=this.authService.userId();if(!r)throw new Error("\u05DE\u05E9\u05EA\u05DE\u05E9 \u05DC\u05D0 \u05DE\u05D7\u05D5\u05D1\u05E8");if(!this.isAdmin())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D9\u05E6\u05D5\u05E8 \u05D4\u05D6\u05DE\u05E0\u05D5\u05EA");try{let t=new Date;return t.setDate(t.getDate()+(e.expiresInDays??7)),yield this.firestoreService.createDocument("invites",{familyId:e.familyId,familyName:e.familyName,role:e.role,createdBy:r,expiresAt:v.fromDate(t)})}catch(t){throw console.error("Error creating invite:",t),t}})}acceptInvite(e){return a(this,null,function*(){let r=this.authService.userId(),t=this.authService.user();if(!r||!t)throw new Error("\u05DE\u05E9\u05EA\u05DE\u05E9 \u05DC\u05D0 \u05DE\u05D7\u05D5\u05D1\u05E8");try{let i=yield this.firestoreService.getDocument(`invites/${e}`);if(!i)throw new Error("\u05D4\u05D6\u05DE\u05E0\u05D4 \u05DC\u05D0 \u05E0\u05DE\u05E6\u05D0\u05D4");if(i.usedBy)throw new Error("\u05D4\u05D4\u05D6\u05DE\u05E0\u05D4 \u05DB\u05D1\u05E8 \u05E0\u05D5\u05E6\u05DC\u05D4");if(i.expiresAt.toDate()<new Date)throw new Error("\u05D4\u05D4\u05D6\u05DE\u05E0\u05D4 \u05E4\u05D2\u05D4");return yield this.firestoreService.setDocument(`families/${i.familyId}/members/${r}`,{displayName:t.displayName,email:t.email,photoURL:t.photoURL,role:i.role,joinedAt:this.firestoreService.getServerTimestamp(),invitedBy:i.createdBy}),yield this.firestoreService.updateDocument(`invites/${e}`,{usedBy:r,usedAt:this.firestoreService.getServerTimestamp()}),yield this.authService.addFamilyMembership(i.familyId,i.role),i.familyId}catch(i){throw console.error("Error accepting invite:",i),i}})}updateMemberRole(e,r){return a(this,null,function*(){let t=this.familyId(),i=this.authService.userId();if(!t||!i)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.isAdmin())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E9\u05E0\u05D5\u05EA \u05EA\u05E4\u05E7\u05D9\u05D3\u05D9\u05DD");if(e===i)throw new Error("\u05DC\u05D0 \u05E0\u05D9\u05EA\u05DF \u05DC\u05E9\u05E0\u05D5\u05EA \u05D0\u05EA \u05D4\u05EA\u05E4\u05E7\u05D9\u05D3 \u05E9\u05DC\u05DA");if(this._currentFamily()?.ownerUserId===e)throw new Error("\u05DC\u05D0 \u05E0\u05D9\u05EA\u05DF \u05DC\u05E9\u05E0\u05D5\u05EA \u05D0\u05EA \u05D4\u05EA\u05E4\u05E7\u05D9\u05D3 \u05E9\u05DC \u05D1\u05E2\u05DC \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4");try{yield this.firestoreService.updateDocument(`families/${t}/members/${e}`,{role:r}),yield this.loadMembers(t)}catch(d){throw console.error("Error updating member role:",d),d}})}removeMember(e){return a(this,null,function*(){let r=this.familyId(),t=this.authService.userId();if(!r||!t)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.isAdmin())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D4\u05E1\u05D9\u05E8 \u05D7\u05D1\u05E8\u05D9\u05DD");if(e===t)throw new Error("\u05DC\u05D0 \u05E0\u05D9\u05EA\u05DF \u05DC\u05D4\u05E1\u05D9\u05E8 \u05D0\u05EA \u05E2\u05E6\u05DE\u05DA");if(this._currentFamily()?.ownerUserId===e)throw new Error("\u05DC\u05D0 \u05E0\u05D9\u05EA\u05DF \u05DC\u05D4\u05E1\u05D9\u05E8 \u05D0\u05EA \u05D1\u05E2\u05DC \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4");try{yield this.firestoreService.deleteDocument(`families/${r}/members/${e}`),yield this.loadMembers(r)}catch(s){throw console.error("Error removing member:",s),s}})}leaveFamily(){return a(this,null,function*(){let e=this.familyId(),r=this.authService.userId();if(!e||!r)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(this.isOwner())throw new Error("\u05D1\u05E2\u05DC \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4 \u05DC\u05D0 \u05D9\u05DB\u05D5\u05DC \u05DC\u05E2\u05D6\u05D5\u05D1. \u05D9\u05E9 \u05DC\u05D4\u05E2\u05D1\u05D9\u05E8 \u05D1\u05E2\u05DC\u05D5\u05EA \u05D0\u05D5 \u05DC\u05DE\u05D7\u05D5\u05E7 \u05D0\u05EA \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4");try{yield this.firestoreService.deleteDocument(`families/${e}/members/${r}`),yield this.authService.removeFamilyMembership(e),this._currentFamily.set(null),this._members.set([]),this._children.set([])}catch(t){throw console.error("Error leaving family:",t),t}})}getChild(e){return this._children().find(r=>r.id===e)}getChildren(e){return this._children().filter(r=>e.includes(r.id))}getMember(e){return this._members().find(r=>r.id===e)}clearFamily(){this._currentFamily.set(null),this._members.set([]),this._children.set([]),this._error.set(null)}clearError(){this._error.set(null)}static \u0275fac=function(r){return new(r||o)(m(w),m(D))};static \u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"})};export{h as a,C as b,b as c,I as d};
