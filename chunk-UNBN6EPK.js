import{a as nt}from"./chunk-DZ33CNJ2.js";import"./chunk-UG5JRMFQ.js";import{a as _}from"./chunk-6ETVNFEW.js";import{a as it,b as ot}from"./chunk-2TCOEAW5.js";import{c as Z,g as tt}from"./chunk-6EYLVA3C.js";import{a as et}from"./chunk-ZP7QJX4J.js";import"./chunk-4S4SHBAA.js";import"./chunk-4SS6VL3O.js";import"./chunk-PBF26NQQ.js";import{a as J,b as K}from"./chunk-IU263WV3.js";import"./chunk-ISTWEN7X.js";import"./chunk-HVH6PFSI.js";import{b as M,c as X,d as Y}from"./chunk-VKZEWMLF.js";import"./chunk-GY27VXU3.js";import{d as N}from"./chunk-WPQFOBGJ.js";import{a as z,b as R,d as H,e as q,f as G}from"./chunk-OHJUE5IH.js";import"./chunk-ZOWI4QAM.js";import{d as V,i as $}from"./chunk-HH43CGJO.js";import{a as x,e as Q,i as W,j}from"./chunk-IGP4P7SY.js";import{j as B}from"./chunk-3EH3MU74.js";import{Ab as O,Bb as E,Cb as r,Db as a,Eb as k,Lb as D,Pb as v,Rb as d,Sa as m,T as b,Y as l,ac as A,ba as g,ca as p,dc as u,ec as U,fb as F,fc as L,hc as T,oa as f,tc as S,vb as C,wb as y,zb as w}from"./chunk-HNLZOKXJ.js";import{a as I,b as P,f as c}from"./chunk-ATWMZ64T.js";var h=class n{firestoreService=l(W);authService=l(j);familyService=l(N);catalogService=l(_);shoppingService=l(Y);_favorites=f([]);_isLoading=f(!1);_error=f(null);favorites=this._favorites.asReadonly();isLoading=this._isLoading.asReadonly();error=this._error.asReadonly();sortedFavorites=S(()=>[...this._favorites()].sort((e,t)=>t.useCount-e.useCount));favoritesWithDetails=S(()=>this._favorites().map(t=>{let i=this.catalogService.getCatalogItem(t.catalogItemId);return i?{favorite:t,catalogItem:i}:null}).filter(t=>t!==null).sort((t,i)=>i.favorite.useCount-t.favorite.useCount));isFavorite(e){return this._favorites().some(t=>t.catalogItemId===e)}getFavorite(e){return this._favorites().find(t=>t.catalogItemId===e)}loadFavorites(){return c(this,null,function*(){let e=this.authService.userId();if(!e){this._favorites.set([]);return}this._isLoading.set(!0),this._error.set(null);try{let t=yield this.firestoreService.getCollection(`users/${e}/shoppingFavorites`,Q("useCount","desc"));this._favorites.set(t)}catch(t){console.error("Error loading favorites:",t),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05D4\u05DE\u05D5\u05E2\u05D3\u05E4\u05D9\u05DD")}finally{this._isLoading.set(!1)}})}addFavorite(e){return c(this,null,function*(){let t=this.authService.userId(),i=this.familyService.familyId();if(!t||!i)throw new Error("\u05DE\u05E9\u05EA\u05DE\u05E9 \u05DC\u05D0 \u05DE\u05D7\u05D5\u05D1\u05E8");if(this.isFavorite(e.catalogItemId))throw new Error("\u05E4\u05E8\u05D9\u05D8 \u05DB\u05D1\u05E8 \u05E0\u05DE\u05E6\u05D0 \u05D1\u05DE\u05D5\u05E2\u05D3\u05E4\u05D9\u05DD");let o={userId:t,familyId:i,catalogItemId:e.catalogItemId,customQuantity:e.customQuantity,customUnit:e.customUnit,useCount:0},s=yield this.firestoreService.createDocument(`users/${t}/shoppingFavorites`,o),at={id:s,userId:t,familyId:i,catalogItemId:e.catalogItemId,customQuantity:e.customQuantity,customUnit:e.customUnit,useCount:0,addedAt:x.now()};return this._favorites.update(st=>[...st,at]),s})}removeFavorite(e){return c(this,null,function*(){let t=this.authService.userId();if(!t)throw new Error("\u05DE\u05E9\u05EA\u05DE\u05E9 \u05DC\u05D0 \u05DE\u05D7\u05D5\u05D1\u05E8");let i=this.getFavorite(e);if(!i)throw new Error("\u05E4\u05E8\u05D9\u05D8 \u05DC\u05D0 \u05E0\u05DE\u05E6\u05D0 \u05D1\u05DE\u05D5\u05E2\u05D3\u05E4\u05D9\u05DD");yield this.firestoreService.deleteDocument(`users/${t}/shoppingFavorites/${i.id}`),this._favorites.update(o=>o.filter(s=>s.catalogItemId!==e))})}toggleFavorite(e){return c(this,null,function*(){return this.isFavorite(e)?(yield this.removeFavorite(e),!1):(yield this.addFavorite({catalogItemId:e}),!0)})}addAllFavoritesToList(){return c(this,null,function*(){let e=this.favoritesWithDetails(),t=0;for(let{favorite:i,catalogItem:o}of e)try{yield this.shoppingService.addItem({catalogItemId:o.id,name:o.nameHe,category:o.category,quantity:i.customQuantity??o.defaultQuantity,unit:i.customUnit??o.defaultUnit,estimatedPrice:o.estimatedPrice}),yield this.incrementUseCount(i.id),t++}catch(s){console.error("Error adding favorite to list:",s)}return t})}addFavoriteToList(e){return c(this,null,function*(){let t=this.getFavorite(e),i=this.catalogService.getCatalogItem(e);if(!t||!i)throw new Error("\u05E4\u05E8\u05D9\u05D8 \u05DC\u05D0 \u05E0\u05DE\u05E6\u05D0");yield this.shoppingService.addItem({catalogItemId:i.id,name:i.nameHe,category:i.category,quantity:t.customQuantity??i.defaultQuantity,unit:t.customUnit??i.defaultUnit,estimatedPrice:i.estimatedPrice}),yield this.incrementUseCount(t.id)})}incrementUseCount(e){return c(this,null,function*(){let t=this.authService.userId();if(!t)return;let i=this._favorites().find(o=>o.id===e);i&&(yield this.firestoreService.updateDocument(`users/${t}/shoppingFavorites/${e}`,{useCount:i.useCount+1,lastUsedAt:this.firestoreService.getServerTimestamp()}),this._favorites.update(o=>o.map(s=>s.id===e?P(I({},s),{useCount:s.useCount+1,lastUsedAt:x.now()}):s)))})}clearError(){this._error.set(null)}static \u0275fac=function(t){return new(t||n)};static \u0275prov=b({token:n,factory:n.\u0275fac,providedIn:"root"})};var ct=(n,e)=>e.favorite.id;function lt(n,e){if(n&1){let t=D();r(0,"button",7),v("click",function(){g(t);let o=d();return p(o.addAllToList())}),r(1,"mat-icon"),u(2,"playlist_add"),a(),u(3," \u05D4\u05D5\u05E1\u05E3 \u05D4\u05DB\u05DC \u05DC\u05E8\u05E9\u05D9\u05DE\u05D4 "),a()}if(n&2){let t=d();E("disabled",t.isAddingAll)}}function mt(n,e){n&1&&(r(0,"div",5),k(1,"mat-spinner",8),r(2,"p"),u(3,"\u05D8\u05D5\u05E2\u05DF \u05DE\u05D5\u05E2\u05D3\u05E4\u05D9\u05DD..."),a()())}function dt(n,e){if(n&1){let t=D();r(0,"div",10)(1,"div",12)(2,"mat-icon"),u(3),a(),r(4,"div",13)(5,"span",14),u(6),a(),r(7,"span",15),u(8),a()()(),r(9,"div",16)(10,"button",17),v("click",function(){let o=g(t).$implicit,s=d(2);return p(s.addToList(o.catalogItem.id))}),r(11,"mat-icon"),u(12,"add_shopping_cart"),a()(),r(13,"button",18),v("click",function(){let o=g(t).$implicit,s=d(2);return p(s.removeFavorite(o.catalogItem.id))}),r(14,"mat-icon"),u(15,"star"),a()()()()}if(n&2){let t=e.$implicit,i=d(2);m(2),A("color",i.getCategoryColor(t.catalogItem.category)),m(),L(" ",i.getCategoryIcon(t.catalogItem.category)," "),m(3),U(t.catalogItem.nameHe),m(2),T(" ",t.favorite.customQuantity??t.catalogItem.defaultQuantity," ",i.getUnitLabel(t.favorite.customUnit??t.catalogItem.defaultUnit)," \xB7 \u20AA",t.catalogItem.estimatedPrice," "),m(2),E("disabled",i.isAdding===t.catalogItem.id)}}function gt(n,e){if(n&1&&(r(0,"div",9),w(1,dt,16,8,"div",10,ct),a(),r(3,"p",11)(4,"mat-icon"),u(5,"info"),a(),u(6," \u05DC\u05D7\u05E5 \u05E2\u05DC \u05DB\u05D5\u05DB\u05D1 \u05D1\u05E7\u05D8\u05DC\u05D5\u05D2 \u05DB\u05D3\u05D9 \u05DC\u05D4\u05D5\u05E1\u05D9\u05E3 \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD \u05DC\u05DE\u05D5\u05E2\u05D3\u05E4\u05D9\u05DD "),a()),n&2){let t=d();m(),O(t.favoritesService.favoritesWithDetails())}}function pt(n,e){if(n&1){let t=D();r(0,"app-empty-state",19),v("action",function(){g(t);let o=d();return p(o.openCatalog())}),a()}}var rt=class n{favoritesService=l(h);catalogService=l(_);dialog=l(Z);snackBar=l(it);isAdding=null;isAddingAll=!1;ngOnInit(){this.catalogService.isLoaded()?this.favoritesService.loadFavorites():this.catalogService.loadCatalog().then(()=>{this.favoritesService.loadFavorites()})}addToList(e){return c(this,null,function*(){this.isAdding=e;try{yield this.favoritesService.addFavoriteToList(e),this.snackBar.open("\u05E0\u05D5\u05E1\u05E3 \u05DC\u05E8\u05E9\u05D9\u05DE\u05D4","",{duration:2e3})}catch(t){this.snackBar.open(t.message||"\u05E9\u05D2\u05D9\u05D0\u05D4","\u05E1\u05D2\u05D5\u05E8",{duration:3e3})}finally{this.isAdding=null}})}addAllToList(){return c(this,null,function*(){this.isAddingAll=!0;try{let e=yield this.favoritesService.addAllFavoritesToList();this.snackBar.open(`\u05E0\u05D5\u05E1\u05E4\u05D5 ${e} \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD \u05DC\u05E8\u05E9\u05D9\u05DE\u05D4`,"",{duration:2e3})}catch(e){this.snackBar.open(e.message||"\u05E9\u05D2\u05D9\u05D0\u05D4","\u05E1\u05D2\u05D5\u05E8",{duration:3e3})}finally{this.isAddingAll=!1}})}removeFavorite(e){return c(this,null,function*(){try{yield this.favoritesService.removeFavorite(e),this.snackBar.open("\u05D4\u05D5\u05E1\u05E8 \u05DE\u05D4\u05DE\u05D5\u05E2\u05D3\u05E4\u05D9\u05DD","",{duration:2e3})}catch(t){this.snackBar.open(t.message||"\u05E9\u05D2\u05D9\u05D0\u05D4","\u05E1\u05D2\u05D5\u05E8",{duration:3e3})}})}openCatalog(){this.dialog.open(nt,{width:"100%",maxWidth:"600px",height:"80vh",panelClass:"item-picker-dialog"})}getCategoryIcon(e){return M(e).icon}getCategoryColor(e){return M(e).color}getUnitLabel(e){return X(e).shortHe}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=F({type:n,selectors:[["app-staples"]],decls:12,vars:2,consts:[[1,"staples-page"],[1,"page-header"],[1,"header-top"],["mat-icon-button","","routerLink","../"],["mat-flat-button","","color","primary",1,"add-all-btn",3,"disabled"],[1,"loading-container"],["icon","star_border","title","\u05D0\u05D9\u05DF \u05DE\u05D5\u05E2\u05D3\u05E4\u05D9\u05DD","description","\u05D4\u05D5\u05E1\u05D9\u05E4\u05D5 \u05DE\u05D5\u05E6\u05E8\u05D9\u05DD \u05E9\u05D0\u05EA\u05DD \u05E7\u05D5\u05E0\u05D9\u05DD \u05D1\u05D0\u05D5\u05E4\u05DF \u05E7\u05D1\u05D5\u05E2","actionLabel","\u05D1\u05D7\u05E8 \u05DE\u05D5\u05E6\u05E8\u05D9\u05DD","actionIcon","add"],["mat-flat-button","","color","primary",1,"add-all-btn",3,"click","disabled"],["diameter","40"],[1,"favorites-list"],[1,"favorite-item"],[1,"usage-hint"],[1,"item-info"],[1,"item-details"],[1,"item-name"],[1,"item-meta"],[1,"item-actions"],["mat-icon-button","",3,"click","disabled"],["mat-icon-button","",1,"remove-btn",3,"click"],["icon","star_border","title","\u05D0\u05D9\u05DF \u05DE\u05D5\u05E2\u05D3\u05E4\u05D9\u05DD","description","\u05D4\u05D5\u05E1\u05D9\u05E4\u05D5 \u05DE\u05D5\u05E6\u05E8\u05D9\u05DD \u05E9\u05D0\u05EA\u05DD \u05E7\u05D5\u05E0\u05D9\u05DD \u05D1\u05D0\u05D5\u05E4\u05DF \u05E7\u05D1\u05D5\u05E2","actionLabel","\u05D1\u05D7\u05E8 \u05DE\u05D5\u05E6\u05E8\u05D9\u05DD","actionIcon","add",3,"action"]],template:function(t,i){t&1&&(r(0,"div",0)(1,"header",1)(2,"div",2)(3,"button",3)(4,"mat-icon"),u(5,"arrow_forward"),a()(),r(6,"h1"),u(7,"\u05DE\u05D5\u05E2\u05D3\u05E4\u05D9\u05DD"),a()(),C(8,lt,4,1,"button",4),a(),C(9,mt,4,0,"div",5)(10,gt,7,0)(11,pt,1,0,"app-empty-state",6),a()),t&2&&(m(8),y(i.favoritesService.favoritesWithDetails().length>0?8:-1),m(),y(i.favoritesService.isLoading()?9:i.favoritesService.favoritesWithDetails().length>0?10:11))},dependencies:[B,$,V,H,R,z,G,q,tt,ot,K,J,et],styles:[".staples-page[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.5rem}.page-header[_ngcontent-%COMP%]   .header-top[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;margin-bottom:1rem}.page-header[_ngcontent-%COMP%]   .header-top[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{font-size:1.5rem;font-weight:700;margin:0;color:var(--text-primary)}.page-header[_ngcontent-%COMP%]   .add-all-btn[_ngcontent-%COMP%]{width:100%}.page-header[_ngcontent-%COMP%]   .add-all-btn[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{margin-inline-end:.5rem}.loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3rem;gap:1rem}.loading-container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--text-secondary);margin:0}.favorites-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.favorite-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:.75rem 1rem;background:var(--surface-primary);border:1px solid var(--border-subtle);border-radius:.75rem;transition:all .15s ease}.favorite-item[_ngcontent-%COMP%]:hover{background:var(--surface-hover)}.favorite-item[_ngcontent-%COMP%]   .item-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem}.favorite-item[_ngcontent-%COMP%]   .item-info[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:24px;width:24px;height:24px}.favorite-item[_ngcontent-%COMP%]   .item-details[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.125rem}.favorite-item[_ngcontent-%COMP%]   .item-name[_ngcontent-%COMP%]{font-size:.9375rem;color:var(--text-primary);font-weight:500}.favorite-item[_ngcontent-%COMP%]   .item-meta[_ngcontent-%COMP%]{font-size:.75rem;color:var(--text-secondary)}.favorite-item[_ngcontent-%COMP%]   .item-actions[_ngcontent-%COMP%]{display:flex;gap:.25rem}.favorite-item[_ngcontent-%COMP%]   .remove-btn[_ngcontent-%COMP%]{color:#ffc107}.favorite-item[_ngcontent-%COMP%]   .remove-btn[_ngcontent-%COMP%]:hover{color:var(--text-tertiary)}.usage-hint[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:.5rem;padding:1rem;margin:0;color:var(--text-tertiary);font-size:.8125rem;text-align:center}.usage-hint[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px;width:18px;height:18px}"]})};export{rt as StaplesComponent};
