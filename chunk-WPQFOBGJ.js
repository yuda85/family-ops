import{a as f,e as u,i as g,j as v}from"./chunk-IGP4P7SY.js";import{T as y,X as m,oa as s,tc as o}from"./chunk-HNLZOKXJ.js";import{f as a}from"./chunk-ATWMZ64T.js";var d=[{id:"school",labelHe:"\u05D1\u05D9\u05EA \u05E1\u05E4\u05E8",icon:"school",color:"#5c7cfa"},{id:"activity",labelHe:"\u05D7\u05D5\u05D2",icon:"sports_soccer",color:"#ff922b"},{id:"family",labelHe:"\u05DE\u05E9\u05E4\u05D7\u05D4",icon:"family_restroom",color:"#c4704f"},{id:"general",labelHe:"\u05DB\u05DC\u05DC\u05D9",icon:"event",color:"#868e96"},{id:"vacation",labelHe:"\u05D7\u05D5\u05E4\u05E9\u05D4",icon:"beach_access",color:"#20c997"},{id:"car",labelHe:"\u05E8\u05DB\u05D1",icon:"directions_car",color:"#845ef7"},{id:"health",labelHe:"\u05D1\u05E8\u05D9\u05D0\u05D5\u05EA",icon:"medical_services",color:"#e64980"},{id:"other",labelHe:"\u05D0\u05D7\u05E8",icon:"more_horiz",color:"#b5a795"}];function C(n){return d.find(e=>e.id===n)??d[d.length-1]}var w=["#e07a5f","#81b1cb","#87a878","#a89cc8","#f4a261","#e9c46a","#2a9d8f","#e76f51"];function p(n){let e=w.filter(r=>!n.includes(r));return e.length>0?e[0]:w[0]}var b=class n{constructor(e,r){this.firestoreService=e;this.authService=r}_currentFamily=s(null);_members=s([]);_children=s([]);_isLoading=s(!1);_error=s(null);currentFamily=this._currentFamily.asReadonly();members=this._members.asReadonly();children=this._children.asReadonly();isLoading=this._isLoading.asReadonly();error=this._error.asReadonly();familyId=o(()=>this._currentFamily()?.id??null);familyName=o(()=>this._currentFamily()?.name??null);currentUserRole=o(()=>{let e=this.familyId();return e?this.authService.getFamilyRole(e):null});isOwner=o(()=>this.currentUserRole()==="owner");isAdmin=o(()=>{let e=this.currentUserRole();return e==="owner"||e==="admin"});canEdit=o(()=>{let e=this.currentUserRole();return e==="owner"||e==="admin"||e==="member"});sortedChildren=o(()=>[...this._children()].sort((e,r)=>e.order-r.order));loadFamily(e){return a(this,null,function*(){this._isLoading.set(!0),this._error.set(null);try{let r=yield this.firestoreService.getDocument(`families/${e}`);if(!r)throw new Error("\u05DE\u05E9\u05E4\u05D7\u05D4 \u05DC\u05D0 \u05E0\u05DE\u05E6\u05D0\u05D4");this._currentFamily.set(r),yield Promise.all([this.loadMembers(e),this.loadChildren(e)])}catch(r){throw console.error("Error loading family:",r),this._error.set(r.message||"\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4"),r}finally{this._isLoading.set(!1)}})}loadMembers(e){return a(this,null,function*(){let r=yield this.firestoreService.getCollection(`families/${e}/members`);this._members.set(r)})}loadChildren(e){return a(this,null,function*(){let r=yield this.firestoreService.getCollection(`families/${e}/children`,u("order","asc"));this._children.set(r)})}createFamily(e){return a(this,null,function*(){let r=this.authService.userId(),i=this.authService.user();if(!r||!i)throw new Error("\u05DE\u05E9\u05EA\u05DE\u05E9 \u05DC\u05D0 \u05DE\u05D7\u05D5\u05D1\u05E8");this._isLoading.set(!0),this._error.set(null);try{let t=yield this.firestoreService.createDocument("families",{name:e.name,ownerUserId:r});return yield this.firestoreService.setDocument(`families/${t}/members/${r}`,{displayName:i.displayName,email:i.email,photoURL:i.photoURL,role:"owner",joinedAt:this.firestoreService.getServerTimestamp(),invitedBy:r}),yield this.authService.addFamilyMembership(t,"owner"),t}catch(t){throw console.error("Error creating family:",t),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D9\u05E6\u05D9\u05E8\u05EA \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4"),t}finally{this._isLoading.set(!1)}})}updateFamily(e){return a(this,null,function*(){let r=this.familyId();if(!r)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.isAdmin())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E2\u05D3\u05DB\u05DF \u05D0\u05EA \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4");try{yield this.firestoreService.updateDocument(`families/${r}`,e),yield this.loadFamily(r)}catch(i){throw console.error("Error updating family:",i),i}})}addChild(e){return a(this,null,function*(){let r=this.familyId(),i=this.authService.userId();if(!r||!i)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D4\u05D5\u05E1\u05D9\u05E3 \u05D9\u05DC\u05D3\u05D9\u05DD");try{let t=this._children(),l=t.map(I=>I.color),c=e.color??p(l),D=t.length,h={name:e.name,color:c,order:D,createdBy:i};e.birthYear!==void 0&&e.birthYear!==null&&(h.birthYear=e.birthYear);let E=yield this.firestoreService.createDocument(`families/${r}/children`,h);return yield this.loadChildren(r),E}catch(t){throw console.error("Error adding child:",t),t}})}updateChild(e,r){return a(this,null,function*(){let i=this.familyId();if(!i)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E2\u05D3\u05DB\u05DF \u05D9\u05DC\u05D3\u05D9\u05DD");try{yield this.firestoreService.updateDocument(`families/${i}/children/${e}`,r),yield this.loadChildren(i)}catch(t){throw console.error("Error updating child:",t),t}})}deleteChild(e){return a(this,null,function*(){let r=this.familyId();if(!r)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05DE\u05D7\u05D5\u05E7 \u05D9\u05DC\u05D3\u05D9\u05DD");try{yield this.firestoreService.deleteDocument(`families/${r}/children/${e}`),yield this.loadChildren(r)}catch(i){throw console.error("Error deleting child:",i),i}})}createInvite(e){return a(this,null,function*(){let r=this.authService.userId();if(!r)throw new Error("\u05DE\u05E9\u05EA\u05DE\u05E9 \u05DC\u05D0 \u05DE\u05D7\u05D5\u05D1\u05E8");if(!this.isAdmin())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D9\u05E6\u05D5\u05E8 \u05D4\u05D6\u05DE\u05E0\u05D5\u05EA");try{let i=new Date;return i.setDate(i.getDate()+(e.expiresInDays??7)),yield this.firestoreService.createDocument("invites",{familyId:e.familyId,familyName:e.familyName,role:e.role,createdBy:r,expiresAt:f.fromDate(i)})}catch(i){throw console.error("Error creating invite:",i),i}})}acceptInvite(e){return a(this,null,function*(){let r=this.authService.userId(),i=this.authService.user();if(!r||!i)throw new Error("\u05DE\u05E9\u05EA\u05DE\u05E9 \u05DC\u05D0 \u05DE\u05D7\u05D5\u05D1\u05E8");try{let t=yield this.firestoreService.getDocument(`invites/${e}`);if(!t)throw new Error("\u05D4\u05D6\u05DE\u05E0\u05D4 \u05DC\u05D0 \u05E0\u05DE\u05E6\u05D0\u05D4");if(t.usedBy)throw new Error("\u05D4\u05D4\u05D6\u05DE\u05E0\u05D4 \u05DB\u05D1\u05E8 \u05E0\u05D5\u05E6\u05DC\u05D4");if(t.expiresAt.toDate()<new Date)throw new Error("\u05D4\u05D4\u05D6\u05DE\u05E0\u05D4 \u05E4\u05D2\u05D4");return yield this.firestoreService.setDocument(`families/${t.familyId}/members/${r}`,{displayName:i.displayName,email:i.email,photoURL:i.photoURL,role:t.role,joinedAt:this.firestoreService.getServerTimestamp(),invitedBy:t.createdBy}),yield this.firestoreService.updateDocument(`invites/${e}`,{usedBy:r,usedAt:this.firestoreService.getServerTimestamp()}),yield this.authService.addFamilyMembership(t.familyId,t.role),t.familyId}catch(t){throw console.error("Error accepting invite:",t),t}})}updateMemberRole(e,r){return a(this,null,function*(){let i=this.familyId(),t=this.authService.userId();if(!i||!t)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.isAdmin())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E9\u05E0\u05D5\u05EA \u05EA\u05E4\u05E7\u05D9\u05D3\u05D9\u05DD");if(e===t)throw new Error("\u05DC\u05D0 \u05E0\u05D9\u05EA\u05DF \u05DC\u05E9\u05E0\u05D5\u05EA \u05D0\u05EA \u05D4\u05EA\u05E4\u05E7\u05D9\u05D3 \u05E9\u05DC\u05DA");if(this._currentFamily()?.ownerUserId===e)throw new Error("\u05DC\u05D0 \u05E0\u05D9\u05EA\u05DF \u05DC\u05E9\u05E0\u05D5\u05EA \u05D0\u05EA \u05D4\u05EA\u05E4\u05E7\u05D9\u05D3 \u05E9\u05DC \u05D1\u05E2\u05DC \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4");try{yield this.firestoreService.updateDocument(`families/${i}/members/${e}`,{role:r}),yield this.loadMembers(i)}catch(c){throw console.error("Error updating member role:",c),c}})}removeMember(e){return a(this,null,function*(){let r=this.familyId(),i=this.authService.userId();if(!r||!i)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.isAdmin())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D4\u05E1\u05D9\u05E8 \u05D7\u05D1\u05E8\u05D9\u05DD");if(e===i)throw new Error("\u05DC\u05D0 \u05E0\u05D9\u05EA\u05DF \u05DC\u05D4\u05E1\u05D9\u05E8 \u05D0\u05EA \u05E2\u05E6\u05DE\u05DA");if(this._currentFamily()?.ownerUserId===e)throw new Error("\u05DC\u05D0 \u05E0\u05D9\u05EA\u05DF \u05DC\u05D4\u05E1\u05D9\u05E8 \u05D0\u05EA \u05D1\u05E2\u05DC \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4");try{yield this.firestoreService.deleteDocument(`families/${r}/members/${e}`),yield this.loadMembers(r)}catch(l){throw console.error("Error removing member:",l),l}})}leaveFamily(){return a(this,null,function*(){let e=this.familyId(),r=this.authService.userId();if(!e||!r)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(this.isOwner())throw new Error("\u05D1\u05E2\u05DC \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4 \u05DC\u05D0 \u05D9\u05DB\u05D5\u05DC \u05DC\u05E2\u05D6\u05D5\u05D1. \u05D9\u05E9 \u05DC\u05D4\u05E2\u05D1\u05D9\u05E8 \u05D1\u05E2\u05DC\u05D5\u05EA \u05D0\u05D5 \u05DC\u05DE\u05D7\u05D5\u05E7 \u05D0\u05EA \u05D4\u05DE\u05E9\u05E4\u05D7\u05D4");try{yield this.firestoreService.deleteDocument(`families/${e}/members/${r}`),yield this.authService.removeFamilyMembership(e),this._currentFamily.set(null),this._members.set([]),this._children.set([])}catch(i){throw console.error("Error leaving family:",i),i}})}getChild(e){return this._children().find(r=>r.id===e)}getChildren(e){return this._children().filter(r=>e.includes(r.id))}getMember(e){return this._members().find(r=>r.id===e)}clearFamily(){this._currentFamily.set(null),this._members.set([]),this._children.set([]),this._error.set(null)}clearError(){this._error.set(null)}static \u0275fac=function(r){return new(r||n)(m(g),m(v))};static \u0275prov=y({token:n,factory:n.\u0275fac,providedIn:"root"})};export{d as a,C as b,w as c,b as d};
