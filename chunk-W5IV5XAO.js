import{d as b}from"./chunk-X4QG5DAP.js";import{d as S,e as g,i as v,j as I}from"./chunk-JFU3JZIN.js";import{T as y,Y as h,oa as l,uc as c}from"./chunk-QZLPLYI5.js";import{f as o}from"./chunk-ATWMZ64T.js";var u=[{id:"vegetables",labelHe:"\u05D9\u05E8\u05E7\u05D5\u05EA",icon:"eco",color:"#4caf50",order:0},{id:"fruits",labelHe:"\u05E4\u05D9\u05E8\u05D5\u05EA",icon:"nutrition",color:"#ff9800",order:1},{id:"dairy",labelHe:"\u05DE\u05D5\u05E6\u05E8\u05D9 \u05D7\u05DC\u05D1",icon:"egg_alt",color:"#2196f3",order:2},{id:"meat",labelHe:"\u05D1\u05E9\u05E8 \u05D5\u05D3\u05D2\u05D9\u05DD",icon:"kebab_dining",color:"#c62828",order:3},{id:"bakery",labelHe:"\u05DE\u05D0\u05E4\u05D9\u05DD",icon:"bakery_dining",color:"#8d6e63",order:4},{id:"pantry",labelHe:"\u05DE\u05D6\u05D5\u05D5\u05D4",icon:"kitchen",color:"#795548",order:5},{id:"frozen",labelHe:"\u05E7\u05E4\u05D5\u05D0\u05D9\u05DD",icon:"ac_unit",color:"#00bcd4",order:6},{id:"drinks",labelHe:"\u05DE\u05E9\u05E7\u05D0\u05D5\u05EA",icon:"local_cafe",color:"#673ab7",order:7},{id:"snacks",labelHe:"\u05D7\u05D8\u05D9\u05E4\u05D9\u05DD",icon:"cookie",color:"#ffc107",order:8},{id:"cleaning",labelHe:"\u05E0\u05D9\u05E7\u05D9\u05D5\u05DF",icon:"cleaning_services",color:"#9c27b0",order:9},{id:"personal",labelHe:"\u05D8\u05D9\u05E4\u05D5\u05D7",icon:"spa",color:"#e91e63",order:10},{id:"baby",labelHe:"\u05EA\u05D9\u05E0\u05D5\u05E7\u05D5\u05EA",icon:"child_care",color:"#ff80ab",order:11}];function _(m){return u.find(t=>t.id===m)??u[5]}var C=[{id:"units",labelHe:"\u05D9\u05D7\u05D9\u05D3\u05D5\u05EA",shortHe:"\u05D9\u05D7'"},{id:"kg",labelHe:"\u05E7\u05D9\u05DC\u05D5\u05D2\u05E8\u05DD",shortHe:'\u05E7"\u05D2'},{id:"gram",labelHe:"\u05D2\u05E8\u05DD",shortHe:"\u05D2\u05E8'"},{id:"liter",labelHe:"\u05DC\u05D9\u05D8\u05E8",shortHe:"\u05DC\u05D9\u05D8\u05E8"},{id:"ml",labelHe:"\u05DE\u05D9\u05DC\u05D9\u05DC\u05D9\u05D8\u05E8",shortHe:'\u05DE"\u05DC'},{id:"pack",labelHe:"\u05D7\u05D1\u05D9\u05DC\u05D4",shortHe:"\u05D7\u05D1\u05D9\u05DC\u05D4"}];function L(m){return C.find(t=>t.id===m)??C[0]}var k=class m{firestoreService=h(v);authService=h(I);familyService=h(b);listSubscription;itemsSubscription;_activeList=l(null);_items=l([]);_isLoading=l(!1);_error=l(null);_isSupermarketMode=l(!1);_collapsedCategories=l(new Set);_undoStack=l([]);MAX_UNDO=5;activeList=this._activeList.asReadonly();items=this._items.asReadonly();isLoading=this._isLoading.asReadonly();error=this._error.asReadonly();isSupermarketMode=this._isSupermarketMode.asReadonly();undoStack=this._undoStack.asReadonly();totalCount=c(()=>this._items().length);checkedCount=c(()=>this._items().filter(t=>t.checked).length);progress=c(()=>{let t=this.totalCount();return t===0?0:this.checkedCount()/t*100});estimatedTotal=c(()=>this._items().reduce((t,e)=>t+e.estimatedPrice*e.quantity,0));actualTotal=c(()=>this._items().reduce((t,e)=>{let i=e.actualPrice??e.estimatedPrice;return t+i*e.quantity},0));hasItems=c(()=>this._items().length>0);hasCheckedItems=c(()=>this.checkedCount()>0);isListComplete=c(()=>{let t=this.totalCount();return t>0&&this.checkedCount()===t});groupedItems=c(()=>{let t=this._items(),e=this._collapsedCategories(),i=new Map;for(let r of t){let n=i.get(r.category)||[];n.push(r),i.set(r.category,n)}let s=[];for(let r of u){let n=i.get(r.id);n&&n.length>0&&(n.sort((d,p)=>d.orderInCategory-p.orderInCategory),s.push({category:r.id,categoryMeta:r,items:n,isCollapsed:e.has(r.id),isComplete:n.every(d=>d.checked)}))}return s});completedCategories=c(()=>this.groupedItems().filter(t=>t.isComplete).map(t=>t.category));canUndo=c(()=>this._undoStack().length>0);ngOnDestroy(){this.unsubscribe()}loadActiveList(){return o(this,null,function*(){let t=this.familyService.familyId();if(!t){this._activeList.set(null),this._items.set([]);return}this._isLoading.set(!0),this._error.set(null);try{let e=yield this.firestoreService.getCollection(`families/${t}/shoppingLists`,S("status","==","active"),g("createdAt","desc"));if(e.length>0)this._activeList.set(e[0]),yield this.loadItemsOnce(e[0].id),this.subscribeToItems(e[0].id);else{let i=yield this.createList({name:"\u05E8\u05E9\u05D9\u05DE\u05EA \u05E7\u05E0\u05D9\u05D5\u05EA"}),s=yield this.firestoreService.getDocument(`families/${t}/shoppingLists/${i}`);this._activeList.set(s),this.subscribeToItems(i)}}catch(e){console.error("Error loading shopping list:",e),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05E8\u05E9\u05D9\u05DE\u05EA \u05D4\u05E7\u05E0\u05D9\u05D5\u05EA")}finally{this._isLoading.set(!1)}})}loadItemsOnce(t){return o(this,null,function*(){let e=this.familyService.familyId();if(e)try{let i=yield this.firestoreService.getCollection(`families/${e}/shoppingLists/${t}/items`,g("createdAt","desc"));this._items.set(i)}catch(i){console.error("Error loading items:",i)}})}subscribeToItems(t){let e=this.familyService.familyId();e&&(this.itemsSubscription?.unsubscribe(),this.itemsSubscription=this.firestoreService.getCollection$(`families/${e}/shoppingLists/${t}/items`,g("createdAt","desc")).subscribe({next:i=>{this._items.set(i)},error:i=>{console.error("Error subscribing to items:",i),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD")}}))}unsubscribe(){this.listSubscription?.unsubscribe(),this.itemsSubscription?.unsubscribe()}createList(t){return o(this,null,function*(){let e=this.familyService.familyId(),i=this.authService.userId();if(!e||!i)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D9\u05E6\u05D5\u05E8 \u05E8\u05E9\u05D9\u05DE\u05D5\u05EA");let s={familyId:e,name:t.name,status:"active",estimatedTotal:0,createdBy:i,activeShoppers:[]};return yield this.firestoreService.createDocument(`families/${e}/shoppingLists`,s)})}addItem(t){return o(this,null,function*(){let e=this.familyService.familyId(),i=this.authService.userId(),s=this._activeList()?.id;if(!e||!i)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05EA\u05DE\u05E9 \u05D0\u05D5 \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D9\u05DD");if(!s&&(yield this.loadActiveList(),s=this._activeList()?.id,!s))throw new Error("\u05DC\u05D0 \u05E0\u05D9\u05EA\u05DF \u05DC\u05D9\u05E6\u05D5\u05E8 \u05E8\u05E9\u05D9\u05DE\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D4\u05D5\u05E1\u05D9\u05E3 \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD");let n=this._items().filter(a=>a.category===t.category).reduce((a,f)=>Math.max(a,f.orderInCategory),-1),d={listId:s,catalogItemId:t.catalogItemId||null,name:t.name,category:t.category,quantity:t.quantity,unit:t.unit,estimatedPrice:t.estimatedPrice,checked:!1,orderInCategory:n+1,addedBy:i,addedAt:this.firestoreService.getServerTimestamp(),note:t.note||null},p=yield this.firestoreService.createDocument(`families/${e}/shoppingLists/${s}/items`,d);return yield this.updateListTotal(),p})}updateItem(t,e){return o(this,null,function*(){let i=this.familyService.familyId(),s=this._activeList()?.id;if(!i||!s)throw new Error("\u05D0\u05D9\u05DF \u05E8\u05E9\u05D9\u05DE\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E2\u05D3\u05DB\u05DF \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD");let r={};e.quantity!==void 0&&(r.quantity=e.quantity),e.unit!==void 0&&(r.unit=e.unit),e.estimatedPrice!==void 0&&(r.estimatedPrice=e.estimatedPrice),e.actualPrice!==void 0&&(r.actualPrice=e.actualPrice),e.note!==void 0&&(r.note=e.note||null),e.orderInCategory!==void 0&&(r.orderInCategory=e.orderInCategory),e.checked!==void 0&&(r.checked=e.checked,e.checked?(r.checkedAt=this.firestoreService.getServerTimestamp(),r.checkedBy=this.authService.userId()):(r.checkedAt=null,r.checkedBy=null)),yield this.firestoreService.updateDocument(`families/${i}/shoppingLists/${s}/items/${t}`,r),(e.estimatedPrice!==void 0||e.quantity!==void 0)&&(yield this.updateListTotal())})}toggleItem(t){return o(this,null,function*(){let e=this._items().find(i=>i.id===t);e&&(yield this.updateItem(t,{checked:!e.checked}))})}quickCheck(t){return o(this,null,function*(){let e=this._items().find(i=>i.id===t);e&&(this._undoStack.update(i=>{let s=[...i,{itemId:t,wasChecked:e.checked}];return s.length>this.MAX_UNDO&&s.shift(),s}),yield this.toggleItem(t))})}undoLastCheck(){return o(this,null,function*(){let t=this._undoStack();if(t.length===0)return;let e=t[t.length-1];this._undoStack.update(i=>i.slice(0,-1)),yield this.updateItem(e.itemId,{checked:e.wasChecked})})}removeItem(t){return o(this,null,function*(){let e=this.familyService.familyId(),i=this._activeList()?.id;if(!e||!i)throw new Error("\u05D0\u05D9\u05DF \u05E8\u05E9\u05D9\u05DE\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05DE\u05D7\u05D5\u05E7 \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD");yield this.firestoreService.deleteDocument(`families/${e}/shoppingLists/${i}/items/${t}`),yield this.updateListTotal()})}clearCheckedItems(){return o(this,null,function*(){let t=this.familyService.familyId(),e=this._activeList()?.id;if(!t||!e)throw new Error("\u05D0\u05D9\u05DF \u05E8\u05E9\u05D9\u05DE\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05DE\u05D7\u05D5\u05E7 \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD");let s=this._items().filter(r=>r.checked).map(r=>({type:"delete",path:`families/${t}/shoppingLists/${e}/items/${r.id}`}));s.length>0&&(yield this.firestoreService.batchWrite(s),yield this.updateListTotal())})}updateListTotal(){return o(this,null,function*(){let t=this.familyService.familyId(),e=this._activeList()?.id;if(!t||!e)return;let i=this.estimatedTotal();yield this.firestoreService.updateDocument(`families/${t}/shoppingLists/${e}`,{estimatedTotal:i})})}toggleCategory(t){this._collapsedCategories.update(e=>{let i=new Set(e);return i.has(t)?i.delete(t):i.add(t),i})}enterSupermarketMode(){return o(this,null,function*(){let t=this.familyService.familyId(),e=this._activeList()?.id,i=this.authService.userId();if(!t||!e||!i)return;this._isSupermarketMode.set(!0),this._undoStack.set([]);let s=this._activeList();if(s){let r=[...s.activeShoppers||[]];r.includes(i)||(r.push(i),yield this.firestoreService.updateDocument(`families/${t}/shoppingLists/${e}`,{status:"shopping",activeShoppers:r}))}})}exitSupermarketMode(){return o(this,null,function*(){let t=this.familyService.familyId(),e=this._activeList()?.id,i=this.authService.userId();if(!t||!e||!i)return;this._isSupermarketMode.set(!1),this._undoStack.set([]);let s=this._activeList();if(s){let r=(s.activeShoppers||[]).filter(d=>d!==i),n=r.length===0?"active":"shopping";yield this.firestoreService.updateDocument(`families/${t}/shoppingLists/${e}`,{status:n,activeShoppers:r})}})}completeShopping(t){return o(this,null,function*(){let e=this.familyService.familyId(),i=this.authService.userId(),s=this._activeList();if(!e||!i||!s)throw new Error("\u05D0\u05D9\u05DF \u05E8\u05E9\u05D9\u05DE\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(t.itemPrices)for(let[a,f]of Object.entries(t.itemPrices))yield this.updateItem(a,{actualPrice:f});let r=this._items(),n=r.map(a=>({name:a.name,category:a.category,quantity:a.quantity,unit:a.unit,estimatedPrice:a.estimatedPrice,actualPrice:a.actualPrice??null,wasChecked:a.checked})),d={familyId:e,listId:s.id,listName:s.name??"\u05E8\u05E9\u05D9\u05DE\u05EA \u05E7\u05E0\u05D9\u05D5\u05EA",completedAt:this.firestoreService.getServerTimestamp(),completedBy:i,totalItems:r.length,checkedItems:r.filter(a=>a.checked).length,estimatedTotal:this.estimatedTotal(),actualTotal:t.actualTotal,items:n},p=yield this.firestoreService.createDocument(`families/${e}/shoppingHistory`,d);return yield this.firestoreService.updateDocument(`families/${e}/shoppingLists/${s.id}`,{status:"completed",actualTotal:t.actualTotal,completedAt:this.firestoreService.getServerTimestamp(),completedBy:i,activeShoppers:[]}),this._activeList.set(null),this._items.set([]),this._isSupermarketMode.set(!1),p})}clearError(){this._error.set(null)}static \u0275fac=function(e){return new(e||m)};static \u0275prov=y({token:m,factory:m.\u0275fac,providedIn:"root"})};export{u as a,_ as b,L as c,k as d};
