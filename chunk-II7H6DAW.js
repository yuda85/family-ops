import{a as A}from"./chunk-ES7NJO36.js";import{d as M}from"./chunk-X4QG5DAP.js";import{a as c,d as p,e as E,i as K,j as b}from"./chunk-JFU3JZIN.js";import{T as _,Y as T,oa as g,uc as I}from"./chunk-QZLPLYI5.js";import{a as D,b as w,f}from"./chunk-ATWMZ64T.js";var U=["\u05D0'","\u05D1'","\u05D2'","\u05D3'","\u05D4'","\u05D5'","\u05E9\u05D1\u05EA"],N=["\u05E8\u05D0\u05E9\u05D5\u05DF","\u05E9\u05E0\u05D9","\u05E9\u05DC\u05D9\u05E9\u05D9","\u05E8\u05D1\u05D9\u05E2\u05D9","\u05D7\u05DE\u05D9\u05E9\u05D9","\u05E9\u05D9\u05E9\u05D9","\u05E9\u05D1\u05EA"],$=class S{firestoreService=T(K);authService=T(b);familyService=T(M);calendarService=T(A);_tasks=g([]);_isLoading=g(!1);_error=g(null);_viewStartDate=g(new Date);_viewEndDate=g(new Date);tasks=this._tasks.asReadonly();isLoading=this._isLoading.asReadonly();error=this._error.asReadonly();tasksByDate=I(()=>{let t=this._tasks(),e=new Map;for(let a of t){let i=e.get(a.dateKey)??[];i.push(a),e.set(a.dateKey,i)}for(let[a,i]of e)i.sort((r,s)=>r.startTime.toMillis()-s.startTime.toMillis());return e});myTasks=I(()=>{let t=this.authService.userId();return t?this._tasks().filter(e=>e.driverUserId===t):[]});unassignedTasks=I(()=>this._tasks().filter(t=>!t.driverUserId));generateDateKey(t){let e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${e}-${a}-${i}`}parseDateKey(t){let[e,a,i]=t.split("-").map(Number);return new Date(e,a-1,i)}getHebrewDayName(t,e=!1){return e?N[t]:U[t]}formatDateLabel(t){let e=new Date,a=new Date(e);if(a.setDate(a.getDate()+1),this.generateDateKey(t)===this.generateDateKey(e))return"\u05D4\u05D9\u05D5\u05DD";if(this.generateDateKey(t)===this.generateDateKey(a))return"\u05DE\u05D7\u05E8";let i=this.getHebrewDayName(t.getDay()),r=t.getDate(),s=t.getMonth()+1;return`\u05D9\u05D5\u05DD ${i} ${r}/${s}`}loadTasksForDateRange(t,e){return f(this,null,function*(){let a=this.familyService.familyId();if(!a){this._tasks.set([]);return}this._isLoading.set(!0),this._error.set(null),this._viewStartDate.set(t),this._viewEndDate.set(e);try{let i=this.generateDateKey(t),r=this.generateDateKey(e),s=yield this.firestoreService.getCollection(`families/${a}/transportationTasks`,p("dateKey",">=",i),p("dateKey","<=",r),E("dateKey","asc"));yield this.generateTasksFromEvents(t,e,s);let o=yield this.firestoreService.getCollection(`families/${a}/transportationTasks`,p("dateKey",">=",i),p("dateKey","<=",r),E("dateKey","asc"));this._tasks.set(o)}catch(i){console.error("Error loading transportation tasks:",i),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05DE\u05E9\u05D9\u05DE\u05D5\u05EA \u05D4\u05D4\u05E1\u05E2\u05D4")}finally{this._isLoading.set(!1)}})}generateTasksFromEvents(t,e,a){return f(this,null,function*(){let i=this.familyService.familyId(),r=this.authService.userId();if(!i||!r)return;yield this.calendarService.loadEvents(t,e);let s=this.calendarService.events(),l=this.expandEventsForRange(s,t,e).filter(n=>n.event.needsRide),y=new Set(a.filter(n=>n.eventId).map(n=>`${n.eventId}:${n.dateKey}`)),d=[];for(let n of l){let m=this.generateDateKey(n.instanceDate),v=`${n.event.id}:${m}`;if(!y.has(v)){let h=null,k=n.instanceDate.getDay();n.event.defaultDrivers?.[k]?h=n.event.defaultDrivers[k]:n.event.driverUserId&&(h=n.event.driverUserId);let u={eventId:n.event.id,dateKey:m,date:c.fromDate(n.instanceDate),driverUserId:h,status:"pending",title:n.event.title,category:n.event.category,startTime:c.fromDate(n.instanceStart),endTime:c.fromDate(n.instanceEnd),childrenIds:n.event.childrenIds,isStandalone:!1,createdBy:r};h&&(u.driverAssignedBy=r,u.driverAssignedAt=c.now()),n.event.location&&(u.location=n.event.location),d.push(u)}}for(let n of d)try{yield this.firestoreService.createDocument(`families/${i}/transportationTasks`,n)}catch(m){console.error("Error creating task:",m)}})}assignDriver(t,e){return f(this,null,function*(){let a=this.familyService.familyId(),i=this.authService.userId();if(!a||!i)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E2\u05D3\u05DB\u05DF \u05DE\u05E9\u05D9\u05DE\u05D5\u05EA");try{yield this.firestoreService.updateDocument(`families/${a}/transportationTasks/${t}`,{driverUserId:e,driverAssignedBy:e?i:null,driverAssignedAt:e?c.now():null}),this._tasks.update(r=>r.map(s=>s.id===t?w(D({},s),{driverUserId:e,driverAssignedBy:e?i:void 0,driverAssignedAt:e?c.now():void 0}):s))}catch(r){throw console.error("Error assigning driver:",r),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05E9\u05D9\u05D1\u05D5\u05E5 \u05D4\u05E0\u05D4\u05D2"),r}})}updateTaskStatus(t,e){return f(this,null,function*(){let a=this.familyService.familyId(),i=this.authService.userId();if(!a||!i)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");try{let r={status:e};e==="completed"&&(r.completedAt=c.now(),r.completedBy=i),yield this.firestoreService.updateDocument(`families/${a}/transportationTasks/${t}`,r),this._tasks.update(s=>s.map(o=>o.id===t?D(w(D({},o),{status:e}),e==="completed"&&{completedAt:c.now(),completedBy:i}):o))}catch(r){throw console.error("Error updating task status:",r),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05E2\u05D3\u05DB\u05D5\u05DF \u05E1\u05D8\u05D8\u05D5\u05E1 \u05D4\u05DE\u05E9\u05D9\u05DE\u05D4"),r}})}createStandaloneTask(t){return f(this,null,function*(){let e=this.familyService.familyId(),a=this.authService.userId();if(!e||!a)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D9\u05E6\u05D5\u05E8 \u05DE\u05E9\u05D9\u05DE\u05D5\u05EA");this._isLoading.set(!0),this._error.set(null);try{let i=this.generateDateKey(t.date),r={eventId:null,dateKey:i,date:c.fromDate(t.date),driverUserId:t.driverUserId??null,status:"pending",title:t.title,category:t.category,startTime:c.fromDate(t.startTime),childrenIds:t.childrenIds,isStandalone:!0,createdBy:a};t.driverUserId&&(r.driverAssignedBy=a,r.driverAssignedAt=c.now()),t.endTime&&(r.endTime=c.fromDate(t.endTime)),t.location&&(r.location=t.location),t.notes&&(r.notes=t.notes);let s=yield this.firestoreService.createDocument(`families/${e}/transportationTasks`,r),o=this.generateDateKey(this._viewStartDate()),l=this.generateDateKey(this._viewEndDate());if(i>=o&&i<=l){let y=w(D({},r),{id:s});this._tasks.update(d=>[...d,y])}return s}catch(i){throw console.error("Error creating standalone task:",i),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D9\u05E6\u05D9\u05E8\u05EA \u05D4\u05DE\u05E9\u05D9\u05DE\u05D4"),i}finally{this._isLoading.set(!1)}})}updateTask(t,e){return f(this,null,function*(){let a=this.familyService.familyId(),i=this.authService.userId();if(!a||!i)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E2\u05D3\u05DB\u05DF \u05DE\u05E9\u05D9\u05DE\u05D5\u05EA");try{let r={};e.driverUserId!==void 0&&(r.driverUserId=e.driverUserId,r.driverAssignedBy=e.driverUserId?i:null,r.driverAssignedAt=e.driverUserId?c.now():null),e.status!==void 0&&(r.status=e.status),e.notes!==void 0&&(r.notes=e.notes||null),e.title!==void 0&&(r.title=e.title),e.startTime!==void 0&&(r.startTime=c.fromDate(e.startTime)),e.endTime!==void 0&&(r.endTime=c.fromDate(e.endTime)),e.childrenIds!==void 0&&(r.childrenIds=e.childrenIds),e.location!==void 0&&(r.location=e.location||null),yield this.firestoreService.updateDocument(`families/${a}/transportationTasks/${t}`,r),this._tasks.update(s=>s.map(o=>o.id===t?D(D({},o),r):o))}catch(r){throw console.error("Error updating task:",r),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05E2\u05D3\u05DB\u05D5\u05DF \u05D4\u05DE\u05E9\u05D9\u05DE\u05D4"),r}})}deleteTask(t){return f(this,null,function*(){let e=this.familyService.familyId();if(!e)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05DE\u05D7\u05D5\u05E7 \u05DE\u05E9\u05D9\u05DE\u05D5\u05EA");try{yield this.firestoreService.deleteDocument(`families/${e}/transportationTasks/${t}`),this._tasks.update(a=>a.filter(i=>i.id!==t))}catch(a){throw console.error("Error deleting task:",a),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05DE\u05D7\u05D9\u05E7\u05EA \u05D4\u05DE\u05E9\u05D9\u05DE\u05D4"),a}})}getMyTasksToday(){return f(this,null,function*(){let t=this.familyService.familyId(),e=this.authService.userId(),a=new Date;a.setHours(0,0,0,0);let i=new Date(a);i.setDate(i.getDate()+2),i.setHours(23,59,59,999);let r=this.generateDateKey(a);if(!t||!e)return{date:a,dateKey:r,myTasks:[],totalDuties:0};try{yield this.loadTasksForDateRange(a,i);let s=[],o=new Date(a);for(let d=0;d<3;d++)s.push(this.generateDateKey(o)),o.setDate(o.getDate()+1);let l=this._tasks().filter(d=>s.includes(d.dateKey)&&d.driverUserId===e),y=yield this.buildTaskViews(l);return{date:a,dateKey:r,myTasks:y,totalDuties:y.length}}catch(s){return console.error("Error loading duties:",s),{date:a,dateKey:r,myTasks:[],totalDuties:0}}})}buildWeekView(t){return f(this,null,function*(){let e=[],a=new Date,i=new Date(a);i.setDate(i.getDate()+1);let r=new Date(t);r.setDate(r.getDate()+6),yield this.loadTasksForDateRange(t,r);let s=new Date(t);for(let o=0;o<7;o++){let l=this.generateDateKey(s),y=this._tasks().filter(v=>v.dateKey===l),d=yield this.buildTaskViews(y),n=this.generateDateKey(s)===this.generateDateKey(a),m=this.generateDateKey(s)===this.generateDateKey(i);e.push({date:new Date(s),dateKey:l,dateLabel:this.formatDateLabel(s),dayName:this.getHebrewDayName(s.getDay()),isToday:n,isTomorrow:m,dayOfWeek:s.getDay(),tasks:d,totalTasks:d.length,assignedTasks:d.filter(v=>v.task.driverUserId).length,unassignedTasks:d.filter(v=>!v.task.driverUserId).length}),s.setDate(s.getDate()+1)}return e})}buildTaskViews(t){return f(this,null,function*(){let e=this.authService.userId(),a=this.familyService.members(),i=this.familyService.sortedChildren(),r=[];for(let s of t){let o=null;s.eventId&&(o=yield this.calendarService.getEvent(s.eventId));let l=i.filter(d=>s.childrenIds.includes(d.id)),y=s.driverUserId?a.find(d=>d.id===s.driverUserId)??null:null;r.push({task:s,event:o,children:l,driver:y,isCurrentUserDriver:s.driverUserId===e})}return r.sort((s,o)=>s.task.startTime.toMillis()-o.task.startTime.toMillis()),r})}expandEventsForRange(t,e,a){let i=[];for(let r of t)if(r.recurrence){let s=this.generateRecurringInstances(r,e,a);i.push(...s)}else{let s=r.start.toDate();s>=e&&s<=a&&i.push({event:r,instanceDate:s,instanceStart:s,instanceEnd:r.end.toDate()})}return i}generateRecurringInstances(t,e,a){let i=[],r=t.recurrence,s=t.start.toDate(),o=t.end.toDate(),l=r.endDate.toDate(),y=o.getTime()-s.getTime(),d=s.getHours(),n=s.getMinutes(),m=new Date(Math.max(e.getTime(),s.getTime()));m.setDate(m.getDate()-m.getDay());let v=new Date(Math.min(a.getTime(),l.getTime())),h=new Date(m);for(;h<=v;){let k=h.getDay();if(r.daysOfWeek.includes(k)){let u=new Date(h);if(u.setHours(d,n,0,0),u>=s&&u>=e&&u<=a){let C=new Date(u.getTime()+y);i.push({event:t,instanceDate:new Date(u),instanceStart:u,instanceEnd:C})}}h.setDate(h.getDate()+1)}return i}getWeekStart(t){let e=new Date(t),a=e.getDay(),r=this.familyService.weekStartDay()==="monday"?1:0,s=a-r;return s<0&&(s+=7),e.setDate(e.getDate()-s),e.setHours(0,0,0,0),e}clearError(){this._error.set(null)}static \u0275fac=function(e){return new(e||S)};static \u0275prov=_({token:S,factory:S.\u0275fac,providedIn:"root"})};export{$ as a};
