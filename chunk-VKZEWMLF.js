import{d as b}from"./chunk-WPQFOBGJ.js";import{d as S,e as f,i as v,j as I}from"./chunk-IGP4P7SY.js";import{T as y,Y as g,oa as l,tc as c}from"./chunk-HNLZOKXJ.js";import{f as n}from"./chunk-ATWMZ64T.js";var h=[{id:"vegetables",labelHe:"\u05D9\u05E8\u05E7\u05D5\u05EA",icon:"eco",color:"#4caf50",order:0},{id:"fruits",labelHe:"\u05E4\u05D9\u05E8\u05D5\u05EA",icon:"nutrition",color:"#ff9800",order:1},{id:"dairy",labelHe:"\u05DE\u05D5\u05E6\u05E8\u05D9 \u05D7\u05DC\u05D1",icon:"egg_alt",color:"#2196f3",order:2},{id:"meat",labelHe:"\u05D1\u05E9\u05E8 \u05D5\u05D3\u05D2\u05D9\u05DD",icon:"kebab_dining",color:"#c62828",order:3},{id:"bakery",labelHe:"\u05DE\u05D0\u05E4\u05D9\u05DD",icon:"bakery_dining",color:"#8d6e63",order:4},{id:"pantry",labelHe:"\u05DE\u05D6\u05D5\u05D5\u05D4",icon:"kitchen",color:"#795548",order:5},{id:"frozen",labelHe:"\u05E7\u05E4\u05D5\u05D0\u05D9\u05DD",icon:"ac_unit",color:"#00bcd4",order:6},{id:"drinks",labelHe:"\u05DE\u05E9\u05E7\u05D0\u05D5\u05EA",icon:"local_cafe",color:"#673ab7",order:7},{id:"snacks",labelHe:"\u05D7\u05D8\u05D9\u05E4\u05D9\u05DD",icon:"cookie",color:"#ffc107",order:8},{id:"cleaning",labelHe:"\u05E0\u05D9\u05E7\u05D9\u05D5\u05DF",icon:"cleaning_services",color:"#9c27b0",order:9},{id:"personal",labelHe:"\u05D8\u05D9\u05E4\u05D5\u05D7",icon:"spa",color:"#e91e63",order:10},{id:"baby",labelHe:"\u05EA\u05D9\u05E0\u05D5\u05E7\u05D5\u05EA",icon:"child_care",color:"#ff80ab",order:11}];function _(m){return h.find(e=>e.id===m)??h[5]}var k=[{id:"units",labelHe:"\u05D9\u05D7\u05D9\u05D3\u05D5\u05EA",shortHe:"\u05D9\u05D7'"},{id:"kg",labelHe:"\u05E7\u05D9\u05DC\u05D5\u05D2\u05E8\u05DD",shortHe:'\u05E7"\u05D2'},{id:"gram",labelHe:"\u05D2\u05E8\u05DD",shortHe:"\u05D2\u05E8'"},{id:"liter",labelHe:"\u05DC\u05D9\u05D8\u05E8",shortHe:"\u05DC\u05D9\u05D8\u05E8"},{id:"ml",labelHe:"\u05DE\u05D9\u05DC\u05D9\u05DC\u05D9\u05D8\u05E8",shortHe:'\u05DE"\u05DC'},{id:"pack",labelHe:"\u05D7\u05D1\u05D9\u05DC\u05D4",shortHe:"\u05D7\u05D1\u05D9\u05DC\u05D4"}];function L(m){return k.find(e=>e.id===m)??k[0]}var C=class m{firestoreService=g(v);authService=g(I);familyService=g(b);listSubscription;itemsSubscription;_activeList=l(null);_items=l([]);_isLoading=l(!1);_error=l(null);_isSupermarketMode=l(!1);_collapsedCategories=l(new Set);_undoStack=l([]);MAX_UNDO=5;activeList=this._activeList.asReadonly();items=this._items.asReadonly();isLoading=this._isLoading.asReadonly();error=this._error.asReadonly();isSupermarketMode=this._isSupermarketMode.asReadonly();undoStack=this._undoStack.asReadonly();totalCount=c(()=>this._items().length);checkedCount=c(()=>this._items().filter(e=>e.checked).length);progress=c(()=>{let e=this.totalCount();return e===0?0:this.checkedCount()/e*100});estimatedTotal=c(()=>this._items().reduce((e,t)=>e+t.estimatedPrice*t.quantity,0));actualTotal=c(()=>this._items().reduce((e,t)=>{let i=t.actualPrice??t.estimatedPrice;return e+i*t.quantity},0));hasItems=c(()=>this._items().length>0);hasCheckedItems=c(()=>this.checkedCount()>0);isListComplete=c(()=>{let e=this.totalCount();return e>0&&this.checkedCount()===e});groupedItems=c(()=>{let e=this._items(),t=this._collapsedCategories(),i=new Map;for(let r of e){let o=i.get(r.category)||[];o.push(r),i.set(r.category,o)}let s=[];for(let r of h){let o=i.get(r.id);o&&o.length>0&&(o.sort((d,p)=>d.orderInCategory-p.orderInCategory),s.push({category:r.id,categoryMeta:r,items:o,isCollapsed:t.has(r.id),isComplete:o.every(d=>d.checked)}))}return s});completedCategories=c(()=>this.groupedItems().filter(e=>e.isComplete).map(e=>e.category));canUndo=c(()=>this._undoStack().length>0);ngOnDestroy(){this.unsubscribe()}loadActiveList(){return n(this,null,function*(){let e=this.familyService.familyId();if(!e){this._activeList.set(null),this._items.set([]);return}this._isLoading.set(!0),this._error.set(null);try{let t=yield this.firestoreService.getCollection(`families/${e}/shoppingLists`,S("status","==","active"),f("createdAt","desc"));if(t.length>0)this._activeList.set(t[0]),this.subscribeToItems(t[0].id);else{let i=yield this.createList({name:"\u05E8\u05E9\u05D9\u05DE\u05EA \u05E7\u05E0\u05D9\u05D5\u05EA"}),s=yield this.firestoreService.getDocument(`families/${e}/shoppingLists/${i}`);this._activeList.set(s),this.subscribeToItems(i)}}catch(t){console.error("Error loading shopping list:",t),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05E8\u05E9\u05D9\u05DE\u05EA \u05D4\u05E7\u05E0\u05D9\u05D5\u05EA")}finally{this._isLoading.set(!1)}})}subscribeToItems(e){let t=this.familyService.familyId();t&&(this.itemsSubscription?.unsubscribe(),this.itemsSubscription=this.firestoreService.getCollection$(`families/${t}/shoppingLists/${e}/items`,f("createdAt","desc")).subscribe({next:i=>{this._items.set(i)},error:i=>{console.error("Error subscribing to items:",i),this._error.set("\u05E9\u05D2\u05D9\u05D0\u05D4 \u05D1\u05D8\u05E2\u05D9\u05E0\u05EA \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD")}}))}unsubscribe(){this.listSubscription?.unsubscribe(),this.itemsSubscription?.unsubscribe()}createList(e){return n(this,null,function*(){let t=this.familyService.familyId(),i=this.authService.userId();if(!t||!i)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D9\u05E6\u05D5\u05E8 \u05E8\u05E9\u05D9\u05DE\u05D5\u05EA");let s={familyId:t,name:e.name,status:"active",estimatedTotal:0,createdBy:i,activeShoppers:[]};return yield this.firestoreService.createDocument(`families/${t}/shoppingLists`,s)})}addItem(e){return n(this,null,function*(){let t=this.familyService.familyId(),i=this.authService.userId(),s=this._activeList()?.id;if(!t||!i)throw new Error("\u05D0\u05D9\u05DF \u05DE\u05E9\u05EA\u05DE\u05E9 \u05D0\u05D5 \u05DE\u05E9\u05E4\u05D7\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D9\u05DD");if(!s&&(yield this.loadActiveList(),s=this._activeList()?.id,!s))throw new Error("\u05DC\u05D0 \u05E0\u05D9\u05EA\u05DF \u05DC\u05D9\u05E6\u05D5\u05E8 \u05E8\u05E9\u05D9\u05DE\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05D4\u05D5\u05E1\u05D9\u05E3 \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD");let o=this._items().filter(a=>a.category===e.category).reduce((a,u)=>Math.max(a,u.orderInCategory),-1),d={listId:s,catalogItemId:e.catalogItemId||null,name:e.name,category:e.category,quantity:e.quantity,unit:e.unit,estimatedPrice:e.estimatedPrice,checked:!1,orderInCategory:o+1,addedBy:i,addedAt:this.firestoreService.getServerTimestamp(),note:e.note||null},p=yield this.firestoreService.createDocument(`families/${t}/shoppingLists/${s}/items`,d);return yield this.updateListTotal(),p})}updateItem(e,t){return n(this,null,function*(){let i=this.familyService.familyId(),s=this._activeList()?.id;if(!i||!s)throw new Error("\u05D0\u05D9\u05DF \u05E8\u05E9\u05D9\u05DE\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05E2\u05D3\u05DB\u05DF \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD");let r={};t.quantity!==void 0&&(r.quantity=t.quantity),t.unit!==void 0&&(r.unit=t.unit),t.estimatedPrice!==void 0&&(r.estimatedPrice=t.estimatedPrice),t.actualPrice!==void 0&&(r.actualPrice=t.actualPrice),t.note!==void 0&&(r.note=t.note||null),t.orderInCategory!==void 0&&(r.orderInCategory=t.orderInCategory),t.checked!==void 0&&(r.checked=t.checked,t.checked?(r.checkedAt=this.firestoreService.getServerTimestamp(),r.checkedBy=this.authService.userId()):(r.checkedAt=null,r.checkedBy=null)),yield this.firestoreService.updateDocument(`families/${i}/shoppingLists/${s}/items/${e}`,r),(t.estimatedPrice!==void 0||t.quantity!==void 0)&&(yield this.updateListTotal())})}toggleItem(e){return n(this,null,function*(){let t=this._items().find(i=>i.id===e);t&&(yield this.updateItem(e,{checked:!t.checked}))})}quickCheck(e){return n(this,null,function*(){let t=this._items().find(i=>i.id===e);t&&(this._undoStack.update(i=>{let s=[...i,{itemId:e,wasChecked:t.checked}];return s.length>this.MAX_UNDO&&s.shift(),s}),yield this.toggleItem(e))})}undoLastCheck(){return n(this,null,function*(){let e=this._undoStack();if(e.length===0)return;let t=e[e.length-1];this._undoStack.update(i=>i.slice(0,-1)),yield this.updateItem(t.itemId,{checked:t.wasChecked})})}removeItem(e){return n(this,null,function*(){let t=this.familyService.familyId(),i=this._activeList()?.id;if(!t||!i)throw new Error("\u05D0\u05D9\u05DF \u05E8\u05E9\u05D9\u05DE\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05DE\u05D7\u05D5\u05E7 \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD");yield this.firestoreService.deleteDocument(`families/${t}/shoppingLists/${i}/items/${e}`),yield this.updateListTotal()})}clearCheckedItems(){return n(this,null,function*(){let e=this.familyService.familyId(),t=this._activeList()?.id;if(!e||!t)throw new Error("\u05D0\u05D9\u05DF \u05E8\u05E9\u05D9\u05DE\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(!this.familyService.canEdit())throw new Error("\u05D0\u05D9\u05DF \u05DC\u05DA \u05D4\u05E8\u05E9\u05D0\u05D4 \u05DC\u05DE\u05D7\u05D5\u05E7 \u05E4\u05E8\u05D9\u05D8\u05D9\u05DD");let s=this._items().filter(r=>r.checked).map(r=>({type:"delete",path:`families/${e}/shoppingLists/${t}/items/${r.id}`}));s.length>0&&(yield this.firestoreService.batchWrite(s),yield this.updateListTotal())})}updateListTotal(){return n(this,null,function*(){let e=this.familyService.familyId(),t=this._activeList()?.id;if(!e||!t)return;let i=this.estimatedTotal();yield this.firestoreService.updateDocument(`families/${e}/shoppingLists/${t}`,{estimatedTotal:i})})}toggleCategory(e){this._collapsedCategories.update(t=>{let i=new Set(t);return i.has(e)?i.delete(e):i.add(e),i})}enterSupermarketMode(){return n(this,null,function*(){let e=this.familyService.familyId(),t=this._activeList()?.id,i=this.authService.userId();if(!e||!t||!i)return;this._isSupermarketMode.set(!0),this._undoStack.set([]);let s=this._activeList();if(s){let r=[...s.activeShoppers||[]];r.includes(i)||(r.push(i),yield this.firestoreService.updateDocument(`families/${e}/shoppingLists/${t}`,{status:"shopping",activeShoppers:r}))}})}exitSupermarketMode(){return n(this,null,function*(){let e=this.familyService.familyId(),t=this._activeList()?.id,i=this.authService.userId();if(!e||!t||!i)return;this._isSupermarketMode.set(!1),this._undoStack.set([]);let s=this._activeList();if(s){let r=(s.activeShoppers||[]).filter(d=>d!==i),o=r.length===0?"active":"shopping";yield this.firestoreService.updateDocument(`families/${e}/shoppingLists/${t}`,{status:o,activeShoppers:r})}})}completeShopping(e){return n(this,null,function*(){let t=this.familyService.familyId(),i=this.authService.userId(),s=this._activeList();if(!t||!i||!s)throw new Error("\u05D0\u05D9\u05DF \u05E8\u05E9\u05D9\u05DE\u05D4 \u05E4\u05E2\u05D9\u05DC\u05D4");if(e.itemPrices)for(let[a,u]of Object.entries(e.itemPrices))yield this.updateItem(a,{actualPrice:u});let r=this._items(),o=r.map(a=>({name:a.name,category:a.category,quantity:a.quantity,unit:a.unit,estimatedPrice:a.estimatedPrice,actualPrice:a.actualPrice??null,wasChecked:a.checked})),d={familyId:t,listId:s.id,listName:s.name??"\u05E8\u05E9\u05D9\u05DE\u05EA \u05E7\u05E0\u05D9\u05D5\u05EA",completedAt:this.firestoreService.getServerTimestamp(),completedBy:i,totalItems:r.length,checkedItems:r.filter(a=>a.checked).length,estimatedTotal:this.estimatedTotal(),actualTotal:e.actualTotal,items:o},p=yield this.firestoreService.createDocument(`families/${t}/shoppingHistory`,d);return yield this.firestoreService.updateDocument(`families/${t}/shoppingLists/${s.id}`,{status:"completed",actualTotal:e.actualTotal,completedAt:this.firestoreService.getServerTimestamp(),completedBy:i,activeShoppers:[]}),this._activeList.set(null),this._items.set([]),this._isSupermarketMode.set(!1),p})}clearError(){this._error.set(null)}static \u0275fac=function(t){return new(t||m)};static \u0275prov=y({token:m,factory:m.\u0275fac,providedIn:"root"})};export{h as a,_ as b,L as c,C as d};
